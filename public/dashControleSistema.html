<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle do Sistema</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="css/dashControleSistema.css">
    <script src="js/sessao.js"></script>
</head>

<body onload="carregarInformacoes()">
    <nav class="menu">
        <input type="checkbox" name="chk_hamburguer" id="chk_hamburguer" class="check_hamburguer">

        <section class="hamburguer">
            <span class="menu_lateral">
                <div class="icones_topo">
                    <img class="img_hamb" src="assets/LogoVitalView.png">
                    <img src="./assets/dashboard-icons/activity.svg" data-role="Analista,Administrador">
                    <img src="./assets/dashboard-icons/bar-chart.svg" data-role="Técnico,Administrador">
                    <img src="./assets/dashboard-icons/layout.svg" data-role="Técnico,Administrador">
                </div>

                <div class="icones_baixo">
                    <img src="./assets/dashboard-icons/gerenciar-usuarios.png" data-role="Administrador"
                        style="width: 28px; height: 28px;">
                    <img src="./assets/dashboard-icons/calendar.svg" data-role="Analista,Técnico,Administrador">
                    <img src="./assets/dashboard-icons/users.svg" data-role="Administrador">
                    <img src="./assets/dashboard-icons/hard-drive.svg" data-role="Técnico,Administrador">
                    <img src="./assets/dashboard-icons/help-circle.svg" data-role="Analista,Técnico,Administrador">
                    <img src="./assets/dashboard-icons/log-out.svg" data-role="Analista,Técnico,Administrador">
                </div>
            </span>
        </section>

        <ul>
            <div class="title_hamb">
                <img class="img_hamb" src="assets/LogoVitalView.png" alt="">
                <h2 class="hamb_nome">VitalView</h2>
            </div>
            <div class="menu_topo">
                <h3 class="title_menu">Dashboards</h3>
                <li style="display: flex; align-items: center;" data-role="Analista,Administrador,Técnico">
                    <img src="./assets/dashboard-icons/home.svg" style="width: 20px; margin-right: 4px;"><a
                        href="bemVindo.html">Home</a>
                </li>
                <li style="display: flex; align-items: center;" data-role="Analista,Administrador">
                    <img src="./assets/dashboard-icons/activity.svg" style="width: 20px; margin-right: 4px;"><a
                        href="dashboardAnalista.html">Dash Analista</a>
                </li>
                <li style="display: flex; align-items: center;" data-role="Técnico,Administrador"><img
                        src="./assets/dashboard-icons/bar-chart.svg" style="width: 20px; margin-right: 4px;"><a
                        href="dashboardSuporteMacro.html">Dash Suporte Macro</a></li>
                <li style="display: flex; align-items: center;" data-role="Técnico,Administrador"><img
                        src="./assets/dashboard-icons/layout.svg" style="width: 20px; margin-right: 4px;"><a
                        href="dashboardSuporteMicro.html">Dash Suporte Micro</a></li>
                <li style="display: flex; align-items: center;" data-role="Técnico,Administrador">
                    <img src="./assets/dashboard-icons/wifi (1).svg" style="width: 20px; margin-right: 4px;"><a
                        href="dashRede.html">Dashboard Rede</a>
                </li>
            </div>

            <div class="menu_baixo">
                <h3 class="title_menu">Outras Opções</h3>
                <li style="display: flex; align-items: center;" data-role="Administrador" class="pagina-ativa"><img
                        src="./assets/dashboard-icons/gerenciar-usuarios.png" style="width: 20px; margin-right: 4px;"><a
                        href="dashControleSistema.html">Gerenciar usuários</a></li>
                <li style="display: flex; align-items: center;" data-role="Analista,Técnico,Administrador"><img
                        src="./assets/dashboard-icons/calendar.svg" style="width: 20px; margin-right: 4px;"><a
                        href="historicoAlertas.html">Histórico de Alertas</a></li>
                <li style="display: flex; align-items: center;" data-role="Administrador"><img
                        src="./assets/dashboard-icons/users.svg" style="width: 20px; margin-right: 4px;"><a
                        href="cadastroFuncionarios.html">Cadastro Funcionário</a></li>
                <li style="display: flex; align-items: center;" data-role="Técnico,Administrador"><img
                        src="./assets/dashboard-icons/hard-drive.svg" style="width: 20px; margin-right: 4px;"><a
                        href="cadastroServidores.html">Cadastro Servidores</a></li>
                <li style="display: flex; align-items: center;" data-role="Analista,Técnico,Administrador"><img
                        src="./assets/dashboard-icons/help-circle.svg" style="width: 20px; margin-right: 4px;"><a
                        href="https://vitalviewsptech.atlassian.net/servicedesk/customer/portal/1"
                        target="_blank">Central de Serviço</a></li>
                <li style="display: flex; align-items: center;" data-role="Analista,Técnico,Administrador"><img
                        src="./assets/dashboard-icons/log-out.svg" style="width: 20px; margin-right: 4px;"><a
                        onclick="limparSessao()">Sair</a></li>
            </div>
        </ul>
    </nav>

    <section class="container">
        <section class="nav-dash">
            <section class="secao_logo">
                <a href="dashboardAnalista.html">
                    <img src="assets/LogoVitalView.png" alt="Logo VitalView" class="logo">
                </a>
            </section>
            <section class="secao_logo">
                <h1 class="titulo_header">VitalView</h1>
            </section>
        </section>

        <div class="container-principal">
            <div class="container-graficos">
                <div class="grafico-container">
                    <canvas id="chart-qtd-asa"></canvas>
                </div>

                <div class="grafico-container">
                    <canvas id="chart-alertas-resolvidos"></canvas>
                </div>

                <div class="div-alta-produtividade">
                    <h1 style="font-size: 35px; color: #32b9cd;">Alta produtividade &#9650; <button type="button"
                            class="infoBtn" data-target="infoModalProdutividade">&#9432</button></h1>
                </div>

                <!-- MODAL MTTR-->
                <div id="infoModalProdutividade" class="modal">
                    <div class="modal-content">
                        <h3>Nível de produtividade</h3>
                        <br>
                        <p style="text-align: justify; font-size: 20px;">
                            Define o nível de produtividade da equipe com base na porcentagem de alertas
                            resolvidos:<br><br>
                            &lt; 25%: <span style="color: #f75454;"><b>baixa produtividade</b></span><br>
                            &gt;= 25% e &lt;= 75%: <span style="color: #f7b731;"><b>média produtividade</b></span><br>
                            &gt; 75%: <span style="color: #32b9cd;"><b>alta produtividade</b></span>
                        </p>
                        <button type="button" class="closeBtn">Fechar</button>
                    </div>
                </div>

                <!-- MODAL EDIÇÃO DE FUNCIONÁRIO-->
                <div id="modalEditarUsuario" class="modal">
                    <div class="modal-content">
                        <div class="container-funcionario">
                            <div class="card">
                                <div class="formulario">
                                    <div class="campo">
                                        <span>Nome:</span>
                                        <input id="nome_input" type="text" placeholder="Novo nome" />
                                    </div>
                                    <div class="campo">
                                        <span>CPF:</span>
                                        <input id="cpf_input" type="text" placeholder="Novo cpf" />
                                    </div>
                                    <div class="campo">
                                        <span>Telefone:</span>
                                        <input id="telefone_input" type="text" placeholder="Novo telefone" />
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="formulario">
                                    <div class="campo">
                                        <span>E-mail:</span>
                                        <input id="email_input" type="text" placeholder="meuemail@provedor.com" />
                                    </div>
                                    <div class="campo">
                                        <span>Nova senha:</span>
                                        <input id="senha_input" type="password" placeholder="******" />
                                    </div>
                                    <div class="campo">
                                        <span>Confirmação da Senha:</span>
                                        <input id="confirmacao_senha_input" type="password" placeholder="******" />
                                    </div>

                                    <div class="campo">
                                        <span>Cargo:</span>
                                        <select name="" id="cargo_input">
                                            <option value="">Escolha uma opção</option>
                                        </select>
                                    </div>

                                    <div class="form-actions">
                                        <button type="reset" class="btn cancel"
                                            onclick="fecharModal()">Cancelar</button>
                                        <button id="atualizar" type="submit" class="btn save"
                                            onclick="atualizarUsuario()">Atualizar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODAL EXCLUSÃO DE FUNCIONÁRIO-->
                <div id="modalExcluirUsuario" class="modal">
                    <div class="modal-content">
                        <div class="container-funcionario-exclusao-funcionario">
                            <div class="card-exclusao-usuario">
                                <div class="formulario">
                                    <div class="campo">
                                        <span>Digite "Excluir" para confirmar a exclusão deste usuário</span>
                                        <input id="excluir_input" type="text" placeholder="Excluir" />
                                        <div class="form-actions">
                                            <button type="reset" class="btn cancel"
                                                onclick="fecharModal()">Cancelar</button>
                                            <button id="btn_excluir" type="submit" class="btn excluir disabled"
                                                onclick="excluirUsuario()" disabled>Excluir</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="tabela-container">
                <div class="tabela-header">
                    <h2>Usuários do Sistema</h2>
                    <div class="tabela-acoes">
                        <span>Filtrar por:</span>
                        <select class="filtro-select" id="filtro">
                            <option value="idUsuario">id</option>
                            <option value="nome">nome</option>
                            <option value="cargo">cargo</option>
                            <option value="data_criacao">data de criação</option>
                        </select>
                        <button class="btn-adicionar" title="Adicionar novo usuário"
                            onclick="irTelaCadastroFuncionario()"><img
                                src="assets/dashboard-icons/user-plus-svgrepo-com.png"
                                style="height: 15px; display: flex; justify-content: center; align-items: center;"
                                alt="Adicionar novo usuário"></button>
                    </div>
                </div>

                <div class="tabela-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th id="th-sup-esquerdo">ID</th>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Cargo</th>
                                <th>Data de criação</th>
                                <th>Servidores criados</th>
                                <th id="th-sup-direito">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="info-usuarios">

                        </tbody>
                    </table>
                </div>
            </div>

            <div class="secao-alertas-grafico">
                <div class="tabela-alertas">
                    <div class="tabela-header">
                        <h2>Alertas Resolvidos</h2>
                    </div>

                    <div class="tabela-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th id="th-sup-esquerdo">ID do alerta</th>
                                    <th>Usuário</th>
                                    <th>Cargo</th>
                                    <th>Componente</th>
                                    <th>Uso durante o alerta</th>
                                    <th id="th-sup-direito">Data e hora da correção</th>
                                </tr>
                            </thead>
                            <tbody id="info-alertas-resolvidos">

                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="grafico-alertas">
                    <canvas id="chart-usuarios-alertas"></canvas>
                </div>
            </div>
        </div>
    </section>

    <script>
        let idHospitalVar = sessionStorage.FK_HOSPITAL;

        let infoBtns = document.querySelectorAll('.infoBtn');
        let modals = document.querySelectorAll('.modal');
        let closeBtns = document.querySelectorAll('.closeBtn');
        let editarUsuarioModal = document.querySelector('.btn-editar-usuario');

        infoBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                let target = btn.dataset.target;
                document.getElementById(target).style.display = 'flex';
            });
        });

        closeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('.modal').style.display = 'none';
            });
        });

        modals.forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.style.display = 'none';
            });
        });

        document.addEventListener("click", (event) => {
            if (event.target.classList.contains("btn-editar-usuario")) {
                editarUsuario(event.target);
            }
        });


        function carregarInformacoes() {
            buscarQtdUsuarios();
            buscarUsuariosSistema();
            buscarResolucaoAlertas();
            buscarUsuariosMaisAlertasResolvidos();
            buscarAlertasPendentesResolvidos();
            popularSelectCargos();
        }

        function buscarQtdUsuarios() {
            fetch(`/controle-usuarios/buscar-quantidade-de-usuarios/${idHospitalVar}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                }
            })
                .then(response => {
                    if (response.ok) {
                        response.json().then(resposta => {
                            console.log("Dado recebido: ", resposta);
                            gerarGraficoRosquinha(resposta)
                        })
                    }
                })
                .catch((erro) => {
                    console.error("Erro na requisição: ", erro);
                    alert("Erro na conexão com o servidor.");
                });
        }

        function gerarGraficoRosquinha(dados) {
            console.log("Iniciando plotagem do gráfico de preferências...");

            let labels = [];
            let valores = [];

            for (let i = 0; i < dados.length; i++) {
                let registro = dados[i];
                labels.push(`${registro.cargo}: ${registro.quantidade_usuarios}`);
                valores.push(registro.quantidade_usuarios);
            }


            let config = {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Quantidade de usuários`,
                        data: valores,
                        backgroundColor: ['#f7b731', '#10ac84', '#9b59b6'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        title: {
                            display: true,
                            text: `Quantidade de usuários: ${dados.length}`,
                            font: {
                                size: 20,
                                family: 'Barlow, sans-serif'
                            },
                            color: 'black'
                        }
                    }
                }
            };

            new Chart(
                document.getElementById('chart-qtd-asa'),
                config
            );
        }

        function buscarUsuariosSistema() {
            let filtroEscolhido = filtro.value;

            fetch(`/controle-usuarios/buscar-usuarios-do-sistema/${idHospitalVar}?filtro=${filtroEscolhido}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                },
            })
                .then(response => {
                    if (response.ok) {
                        response.json().then(resposta => {
                            console.log("Dado recebido: ", resposta);
                            gerarTabelaUsuariosSistema(resposta)
                        })
                    }
                })
                .catch((erro) => {
                    console.error("Erro na requisição: ", erro);
                    alert("Erro na conexão com o servidor.");
                });
        }

        filtro.addEventListener('change', () => {
            buscarUsuariosSistema();
        });

        function gerarTabelaUsuariosSistema(dados) {
            let tbodyUsuarios = document.getElementById("info-usuarios");
            tbodyUsuarios.innerHTML = "";

            let id;
            let nome;
            let email;
            let cargo;
            let dataCriacao;
            let servidoresCriados = [];

            for (let i = 0; i < dados.length; i++) {
                let registro = dados[i];

                id = registro.id;
                nome = registro.nome;
                email = registro.email;
                cargo = registro.cargo;
                let dataCriacao = new Date(registro.data_criacao);
                let dataFormatada = dataCriacao.toLocaleDateString("pt-BR", {
                    timeZone: "America/Sao_Paulo"
                });
                servidoresCriados = registro.servidores_criados;

                let linha = `
                <tr>
                    <td>${id}</td>
                    <td>${nome}</td>
                    <td>${email}</td>
                    <td>${cargo}</td>
                    <td>${dataFormatada}</td>
                    <td>${servidoresCriados}</td>
                    <td class="acao-icons">
                        <button class="btn-editar-usuario" onclick="editarUsuario(this)" title="Editar usuário">&#9998;</button>
                        <button class="btn-excluir-usuario" onclick="excluirUsuario(this)">&#x1F5D1;</button>
                    </td>
                </tr>
                `

                tbodyUsuarios.innerHTML += linha;
            }
        }

        function buscarResolucaoAlertas() {
            fetch(`/controle-usuarios/buscar-resolucao-de-alertas/${idHospitalVar}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                }
            })
                .then(response => {
                    if (response.ok) {
                        response.json().then(resposta => {
                            console.log("Dado recebido: ", resposta);
                            gerarTabelaResolucaoAlertas(resposta)
                        })
                    }
                })
                .catch((erro) => {
                    console.error("Erro na requisição: ", erro);
                    alert("Erro na conexão com o servidor.");
                });
        }



        function gerarTabelaResolucaoAlertas(dados) {
            let tbodyUsuarios = document.getElementById("info-alertas-resolvidos");
            tbodyUsuarios.innerHTML = "";

            let idAlerta;
            let usuario;
            let cargo;
            let componente;
            let usoAlerta;

            for (let i = 0; i < dados.length; i++) {
                let registro = dados[i];

                idAlerta = registro.id_alerta;
                usuario = registro.usuario;
                usoAlerta = registro.uso_no_alerta;
                cargo = registro.cargo;
                componente = registro.componente;
                let dataHoraCorrecao = new Date(registro.data_hora_correcao);
                let dataFormatada = dataHoraCorrecao.toLocaleString("pt-BR", {
                    timeZone: "America/Sao_Paulo"
                });

                let linha = `
                <tr>
                    <td>${idAlerta}</td>
                    <td>${usuario}</td>
                    <td>${cargo}</td>
                    <td>${componente}</td>
                    <td>${usoAlerta}%</td>
                    <td>${dataFormatada}</td>
                </tr>
                `
                tbodyUsuarios.innerHTML += linha;
            }
        }


        function irTelaCadastroFuncionario() {
            window.location.href = "cadastroFuncionarios.html";
        }

        function buscarUsuariosMaisAlertasResolvidos() {
            fetch(`/controle-usuarios/buscar-usuarios-com-mais-alertas-resolvidos/${idHospitalVar}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                }
            })
                .then(response => {
                    if (response.ok) {
                        response.json().then(resposta => {
                            console.log("Usuários com mais alertas resolvidos: ", resposta);
                            gerarRankingUsuarios(resposta)
                        })
                    }
                })
                .catch((erro) => {
                    console.error("Erro na requisição: ", erro);
                    alert("Erro na conexão com o servidor.");
                });
        }

        function gerarRankingUsuarios(dados) {
            let listaUsuarios = [];
            let listaTotalResolvidos = [];

            for (let i = 0; i < dados.length; i++) {
                listaUsuarios.push(dados[i].usuario);
                listaTotalResolvidos.push(dados[i].total_resolvidos);
            }

            let ctx3 = document.getElementById('chart-usuarios-alertas').getContext('2d');
            new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: listaUsuarios,
                    datasets: [{
                        label: `Mais resolvidos: ${listaUsuarios[0]}`,
                        data: listaTotalResolvidos,
                        backgroundColor: ['#f75454', '#32b9cd', '#ffd60a', '#10b981', '#8b5cf6'],
                        borderWidth: 1,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Cinco usuários com mais alertas resolvidos',
                            font: {
                                size: 16,
                                weight: 'bold',
                            },
                            color: 'black',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de Alertas',
                                color: 'black'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Usuários',
                                color: 'black'
                            },
                            grid: {
                                display: false
                            },
                        }
                    }
                }
            });
        }

        function buscarAlertasPendentesResolvidos() {
            fetch(`/controle-usuarios/buscar-quantidade-alertas-resolvidos-x-pendentes/${idHospitalVar}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                }
            })
                .then(response => {
                    if (response.ok) {
                        response.json().then(resposta => {
                            console.log("Alertas resolvidos x em alerta: ", resposta);
                            gerarGraficoResolvidoPendente(resposta)
                        })
                    }
                })
                .catch((erro) => {
                    console.error("Erro na requisição: ", erro);
                    alert("Erro na conexão com o servidor.");
                });
        }

        function gerarGraficoResolvidoPendente(dados) {
            let pendentes = dados[0].pendentes;
            let resolvidos = dados[0].resolvidos;

            let ctx2 = document.getElementById('chart-alertas-resolvidos').getContext('2d');
            new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: [`Pendentes: ${pendentes}`, `Resolvidos: ${resolvidos}`],
                    datasets: [{
                        data: [pendentes, resolvidos],
                        backgroundColor: ['#f75454', '#32b9cd']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'Alertas Resolvidos',
                            font: {
                                size: 20,
                                family: 'Barlow, sans-serif'
                            },
                            color: 'black',
                        }
                    }
                }
            });
        }


        function editarUsuario(botao) {
            let linha = botao.closest("tr");
            let colunas = linha.querySelectorAll("td");

            let idUsuario = colunas[0].textContent;
            let nome = colunas[1].textContent;
            let email = colunas[2].textContent;
            let cargoNome = colunas[3].textContent;
            let dataCriacao = colunas[4].textContent;
            let servidoresCriados = colunas[5].textContent;

            fetch(`/controle-usuarios/buscar-usuario/${idUsuario}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                }
            })
                .then(response => {
                    if (response.ok) {
                        response.json().then(resposta => {
                            console.log("Usuário recebido: ", resposta);

                            let cpfUsuario = resposta[0].cpf;
                            let telefoneUsuario = resposta[0].telefone;
                            let senhaUsuario = resposta[0].senha;
                            let cargoUsuario = resposta[0].cargoNome;
                            let idCargo = resposta[0].fkcargo;

                            nome_input.value = nome;
                            cpf_input.value = cpfUsuario;
                            telefone_input.value = telefoneUsuario;
                            email_input.value = email;
                            senha_input.value = "";
                            confirmacao_senha_input.value = "";

                            modalEditarUsuario.style.display = "flex";

                            document.addEventListener("DOMContentLoaded", () => {
                                let cargoSelect = document.getElementById("cargo_input");


                                let cargos = [
                                    { nome: "Analista", id: 1 },
                                    { nome: "Técnico", id: 2 },
                                    { nome: "Administrador", id: 3 }
                                ];

                                cargos.forEach(cargo => {
                                    let opt = document.createElement("option");
                                    opt.value = cargo.id;
                                    opt.textContent = cargo.nome;
                                    cargoSelect.appendChild(opt);
                                });
                            });

                            document.getElementById("atualizar").onclick = function () {
                                atualizarUsuario(idUsuario);
                            };
                        })
                    }
                })
                .catch((erro) => {
                    console.error("Erro na requisição: ", erro);
                    alert("Erro na conexão com o servidor.");
                });
        }

        function atualizarUsuario(idUsuario) {

            let nomeAtualizado = nome_input.value;
            let cpfAtualizado = cpf_input.value;
            let telefoneAtualizado = telefone_input.value;
            let emailAtualizado = email_input.value;
            let senhaAtualizada = senha_input.value;
            let fkCargoAtualizado = Number(cargo_input.value);

            fetch(`/controle-usuarios/atualizar-usuario/${idUsuario}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    idUsuarioServer: idUsuario,
                    nomeServer: nomeAtualizado,
                    cpfServer: cpfAtualizado,
                    telefoneServer: telefoneAtualizado,
                    emailServer: emailAtualizado,
                    senhaNovaServer: senhaAtualizada,
                    cargoServer: fkCargoAtualizado
                })
            }).then(function (resposta) {
                if (resposta.ok) {
                    console.log(resposta);
                    alert(`Usuário alterado com sucesso!`)
                    fecharModal();
                    location.reload();
                }

            }).catch(function (erro) {
                console.log(erro);
            })
        }

        function fecharModal() {
            modalEditarUsuario.style.display = "none";
            modalExcluirUsuario.style.display = "none";

            excluir_input.removeEventListener('input', atualizarEstadoBotaoExclusao);
        }

        function popularSelectCargos() {
            let cargoSelect = document.getElementById("cargo_input");

            let cargos = [
                { nome: "Analista", id: 1 },
                { nome: "Técnico", id: 2 },
                { nome: "Administrador", id: 3 }
            ];

            cargos.forEach(cargo => {
                const opt = document.createElement("option");
                opt.value = cargo.id;
                opt.textContent = cargo.nome;
                cargoSelect.appendChild(opt);
            });
        }

        function excluirUsuario(botao) {
            let linha = botao.closest("tr");
            let colunas = linha.querySelectorAll("td");

            let idUsuario = colunas[0].textContent;
            let nome = colunas[1].textContent;

            fetch(`/controle-usuarios/buscar-usuario/${idUsuario}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                }
            })
                .then(response => {
                    if (response.ok) {
                        response.json().then(resposta => {
                            console.log("Usuário retornado: ", resposta);
                            modalExcluirUsuario.style.display = "flex";

                            excluir_input.value = "";
                            atualizarEstadoBotaoExclusao();

                            excluir_input.addEventListener('input', atualizarEstadoBotaoExclusao);

                            document.getElementById("btn_excluir").onclick = function () {
                                confirmarExclusaoUsuario(idUsuario);
                            };
                        }
                        )
                    }
                })
        }

        function atualizarEstadoBotaoExclusao() {
            let btnExcluir = document.getElementById("btn_excluir");
            let inputTexto = document.getElementById("excluir_input").value;

            if (inputTexto === "Excluir") {
                btnExcluir.classList.remove("disabled");
                btnExcluir.disabled = false;
            } else {
                btnExcluir.classList.add("disabled");
                btnExcluir.disabled = true;
            }
        }

        function confirmarExclusaoUsuario(idUsuario) {
            let excluir = excluir_input.value;

            if (excluir != "Excluir") {
                alert("Digite 'Excluir' para remover este usuário");
                return;
            }

            else {
                fetch(`/controle-usuarios/excluir-usuario/${idUsuario}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        idUsuarioServer: idUsuario
                    })
                })
                    .then(response => {
                        if (response.ok) {
                            response.json().then(resposta => {
                                alert("Usuário removido com sucesso!");
                                fecharModal();
                                location.reload();
                            })
                        }
                    })
            }
        }
    </script>
</body>

</html>