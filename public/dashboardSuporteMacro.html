<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="css/dashboards.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="js/sessao.js"></script>
</head>

<body>

    <header class="escuro">
        <section class="container">

            <nav class="menu">
                <input type="checkbox" name="chk_hamburguer" id="chk_hamburguer" class="check_hamburguer">

                <section class="hamburguer">
                    <span></span>
                    <span></span>
                    <span></span>
                </section>

                <ul>
                    <div class="title_hamb">
                        <img class="img_hamb" src="assets/LogoVitalView.png" alt="">
                        <h2 class="hamb_nome">VitalView</h2>
                    </div>
                    <div class="menu_topo">
                        <h3 class="title_menu">Menu</h3>
                        <li>
                            <a href="dashboard.html"> Dashboard </a>
                        </li>
                        <li>
                            <a href="cadastroserver.html"> Cadastro Servidores </a>
                        </li>
                        <li>
                            <a href="dashboardSuporteMacro.html"> Dashboard Suporte </a>
                        </li>
                    </div>

                    <div class="menu_baixo">
                        <h3 class="title_menu">Outras Opções</h3>
                        <li>
                            <a target="_blank"> Central de Serviço </a>
                        </li>
                        <li>
                            <a href="cadastro.html"> Cadastro </a>
                        </li>
                        <li>
                            <a onclick="limparSessao()"> Sair </a>
                        </li>
                    </div>
                </ul>
            </nav>

            <section class="secao_logo">
                <h1 class="titulo_header">Dashboard Suporte (Macro)</h1>
            </section>

            <section class="secao_logo">
                <a href="dashboard.html">
                    <img src="assets/LogoVitalView.png" alt="Logo VitalView" class="logo">
                </a>
                <div class="linha"></div>
            </section>

        </section>
    </header>

    <main class="container2">
        <a href="dashboardSuporte.html">Clique aqui provisoriamente</a>
        <section class="row kpi-section">
            <div class="card card--sm" id="kpi_1"></div>
            <div class="card card--sm" id="kpi_2"></div>
            <div class="card card--sm" id="kpi_3"></div>
            <div class="card card--sm" id="kpi_4"></div>
        </section>

        <h2 class="section-title">Projeção de Sobrecarga dos Discos</h2>
        <section class="row row--half">
            <div class="card card--lg" id="disco_1"></div>
        </section>

        <h2 class="section-title">DISCO</h2>
        <section class="row">
            <div class="card" id="geral_1"></div>
            <div class="card" id="geral_2"></div>
            <div class="card" id="geral_3"></div>
        </section>

        <h2 class="section-title">RAM</h2>
        <section class="row">
            <div class="card" id="ram_1"></div>
            <div class="card" id="ram_2"></div>
            <div class="card" id="ram_3"></div>
        </section>

        <h2 class="section-title">CPU</h2>
        <section class="row">
            <div class="card" id="cpu_1"></div>
            <div class="card" id="cpu_2"></div>
            <div class="card" id="cpu_3"></div>
        </section>
    </main>

    <script src="js/dashboard.js"></script>

    <script>

        console.log("SESSAO HOSPITAL: ", sessionStorage.FK_HOSPITAL);
        

        const COMPONENTE = 'disco';
        const MESES = ['Jan', 'Fev', 'Mar'];

        // KPIs (mock)
        const KPIS = {
            mais_alertas: { servidor: 'srv1', componente: 'disco', qtd: 9, periodo: 'Jan - Dez' },
            total_alertas_componente: { componente: 'disco', total: 38, periodo: 'Jan - Dez' },
            maior_pico_componente: { componente: 'disco', pico: 89, periodo: 'Jan - Dez' },
            media_disco_usado: { media: 76, periodo: 'Jan - Dez' }
        };

        // Projeção de sobrecarga (mock)
        const PROJECAO = [
            { servidor: 'Servidor 1', uso: 25, data: '22/04/2025' },
            { servidor: 'Servidor 2', uso: 83, data: '19/05/2025' },
            { servidor: 'Servidor 3', uso: 50, data: '30/06/2025' },
            { servidor: 'Servidor 4', uso: 41, data: '04/08/2025' },
            { servidor: 'Servidor 5', uso: 13, data: '10/09/2026' },
        ];

        // DISCO (mock)
        const DISCO_ALERTAS = {
            labels: MESES,
            datasets: [
                { label: 'Serv 1', data: [4, 3, 12] },
                { label: 'Serv 2', data: [3, 4, 8] },
                { label: 'Serv 3', data: [2, 2, 6] },
            ]
        };
        const DISCO_LINHAS = {
            labels: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
            series: [
                { label: 'Serv 1', data: [15, 28, 22, 18, 30, 26, 20] },
                { label: 'Serv 2', data: [12, 35, 18, 24, 28, 19, 14] },
                { label: 'Serv 3', data: [20, 21, 25, 15, 17, 23, 29] },
            ],
            linhaAlvo: 25 // %
        };
        const DISCO_PIZZA = { labels: ['Usado', 'Livre'], data: [54.1, 45.9] };

        // RAM (mock)
        const RAM_ALERTAS = {
            labels: MESES,
            datasets: [
                { label: 'Serv 1', data: [5, 2, 13] },
                { label: 'Serv 2', data: [4, 3, 9] },
                { label: 'Serv 3', data: [3, 2, 7] },
            ]
        };
        const RAM_LINHAS = {
            labels: ['Unidade', 'Segunda', 'Terça', 'Quarta'],
            series: [
                { label: 'Serv 1', data: [16, 30, 34, 28] },
                { label: 'Serv 2', data: [12, 24, 31, 18] },
                { label: 'Serv 3', data: [20, 22, 18, 27] },
            ],
            linhaAlvo: 30
        };
        const RAM_PIZZA = { labels: ['Servidor 1', 'Servidor 2', 'Servidor 3'], data: [29.3, 35.2, 35.5] };

        // CPU (mock)
        const CPU_ALERTAS = {
            labels: MESES,
            datasets: [
                { label: 'Serv 1', data: [6, 14, 18] },
                { label: 'Serv 2', data: [9, 0, 5] },
                { label: 'Serv 3', data: [3, 8, 19] },
            ]
        };
        const CPU_LINHAS = {
            labels: ['Semestre 1', 'Semestre 2', 'Semestre 3', 'Semestre 4', 'Semestre 5'],
            series: [
                { label: 'Serv 1', data: [22, 8, 15, 12, 10] },
                { label: 'Serv 2', data: [9, 18, 7, 14, 9] },
                { label: 'Serv 3', data: [14, 11, 13, 9, 16] },
            ],
            linhaAlvo: 20
        };
        const CPU_PIZZA = { labels: ['Servidor 1', 'Servidor 2', 'Servidor 3'], data: [29.8, 40.4, 29.8] };

        const BR = new Intl.NumberFormat('pt-BR');
        function percent(n) { return `${(Number(n) || 0).toFixed(0)}%`; }


        const LinhaAlvoPlugin = {
            id: 'linhaAlvo',
            afterDatasetsDraw(chart, args, opts) {
                if (!opts || typeof opts.valor !== 'number') return;
                const { ctx, chartArea: { left, right }, scales: { y } } = chart;
                const yPos = y.getPixelForValue(opts.valor);
                ctx.save();
                ctx.strokeStyle = opts.cor || '#e64545';
                ctx.lineWidth = 2;
                ctx.setLineDash([6, 4]);
                ctx.beginPath();
                ctx.moveTo(left, yPos);
                ctx.lineTo(right, yPos);
                ctx.stroke();
                ctx.restore();
            }
        };

        function mountCardCanvas(cardId, title) {
            const card = document.getElementById(cardId);
            if (!card) return null;
            if (!card.dataset.mounted) {
                const h = document.createElement('h3'); h.textContent = title; h.style.marginBottom = '8px';
                const c = document.createElement('canvas'); c.height = 160;
                card.appendChild(h); card.appendChild(c);
                card.dataset.mounted = '1';
            } else {

                const h = card.querySelector('h3'); if (h) h.textContent = title;
            }
            return card.querySelector('canvas');
        }

        function mountKPI(cardId, titulo, valor, subtitulo) {
            const el = document.getElementById(cardId);
            if (!el) return;
            el.innerHTML = '';
            const t = document.createElement('div'); t.textContent = titulo; t.style.opacity = '0.8'; t.style.fontSize = '0.9rem';
            const v = document.createElement('div'); v.textContent = valor; v.style.fontSize = '1.6rem'; v.style.fontWeight = '700';
            el.appendChild(t); el.appendChild(v);
            if (subtitulo) {
                const s = document.createElement('div'); s.textContent = subtitulo; s.style.opacity = '0.7'; s.style.fontSize = '0.8rem';
                el.appendChild(s);
            }
        }


        function renderKPIs() {
            mountKPI('kpi_1', 'Servidor com mais alertas (Jan - Dez)', `${KPIS.mais_alertas.servidor} – ${KPIS.mais_alertas.componente} – ${KPIS.mais_alertas.qtd}`);
            mountKPI('kpi_2', `Total de alertas de ${KPIS.total_alertas_componente.componente} (${KPIS.total_alertas_componente.periodo})`, BR.format(KPIS.total_alertas_componente.total));
            mountKPI('kpi_3', `Maior pico de ${KPIS.maior_pico_componente.componente} (${KPIS.maior_pico_componente.periodo})`, percent(KPIS.maior_pico_componente.pico));
            mountKPI('kpi_4', `Porcentagem média de ${COMPONENTE} usado (Jan - Dez)`, percent(KPIS.media_disco_usado.media));
        }


        function renderProjecao() {
            const host = document.getElementById('disco_1');
            if (!host) return;
            host.innerHTML = `
    <div style="overflow:auto;">
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:8px;">Servidor</th>
            <th style="text-align:left; padding:8px;">Uso de disco</th>
            <th style="text-align:left; padding:8px;">Projeção de sobrecarga</th>
          </tr>
        </thead>
        <tbody>
          ${PROJECAO.map(row => `
            <tr>
              <td style="padding:10px 8px;">${row.servidor}</td>
              <td style="padding:10px 8px; min-width:220px;">
                <div style="height:10px; background:#e9eef3; border-radius:999px; position:relative;">
                  <div style="
                    position:absolute; left:0; top:0; bottom:0; width:${row.uso}%;
                    background:${row.uso >= 75 ? '#d55' : '#4dd0e1'};
                    border-radius:999px;">
                  </div>
                </div>
                <div style="font-size:.9rem; opacity:.8; margin-top:6px;">${row.uso}%</div>
              </td>
              <td style="padding:10px 8px;">${row.data}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
        }

        const registradas = new WeakMap();

        function makeBarGrouped(canvas, labels, datasets, titleY, maxY) {
            if (!canvas) return;
            const antigo = registradas.get(canvas);
            if (antigo) antigo.destroy();

            const chart = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: { labels, datasets: datasets.map(d => ({ ...d })) },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: maxY || undefined,
                            title: titleY ? { display: true, text: titleY } : undefined
                        }
                    }
                }
            });

            registradas.set(canvas, chart);
        }

        function makeLineMulti(canvas, labels, series, alvoPercent) {
            if (!canvas) return;
            const antigo = registradas.get(canvas);
            if (antigo) antigo.destroy();

            const chart = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels,
                    datasets: series.map(s => ({
                        label: s.label,
                        data: s.data,
                        tension: 0.35,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 2,
                        backgroundColor: (ctx) => {
                            const g = ctx.chart.ctx.createLinearGradient(0, 0, 0, 180);
                            g.addColorStop(0, 'rgba(0,0,0,0.12)');
                            g.addColorStop(1, 'rgba(0,0,0,0.0)');
                            return g;
                        }
                    }))
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        linhaAlvo: { valor: typeof alvoPercent === 'number' ? alvoPercent : undefined }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { callback: v => `${v}%` } }
                    }
                },
                plugins: [LinhaAlvoPlugin]
            });

            registradas.set(canvas, chart);
        }

        function makePie(canvas, labels, data) {
            if (!canvas) return;
            const antigo = registradas.get(canvas);
            if (antigo) antigo.destroy();

            const chart = new Chart(canvas.getContext('2d'), {
                type: 'pie',
                data: { labels, datasets: [{ data }] },
                options: { responsive: true, plugins: { legend: { position: 'right' } } }
            });

            registradas.set(canvas, chart);
        }


        function renderDisco() {
            // 1) Quantidade de alertas de disco entre os servidores (barras comparativas)
            makeBarGrouped(
                mountCardCanvas('geral_1', 'Quantidade de alertas de DISCO entre os servidores'),
                DISCO_ALERTAS.labels,
                DISCO_ALERTAS.datasets,
                'Alertas'
            );

            // 2) Porcentagem de disco entre os servidores (linhas)
            makeLineMulti(
                mountCardCanvas('geral_2', 'Porcentagem de DISCO entre os servidores'),
                DISCO_LINHAS.labels,
                DISCO_LINHAS.series,
                DISCO_LINHAS.linhaAlvo
            );

            // 3) Disco livre x Usado (pizza)
            makePie(
                mountCardCanvas('geral_3', 'Disco livre x Usado'),
                DISCO_PIZZA.labels,
                DISCO_PIZZA.data
            );
        }

        function renderRAM() {
            makeBarGrouped(
                mountCardCanvas('ram_1', 'Quantidade de alertas de RAM entre os servidores'),
                RAM_ALERTAS.labels,
                RAM_ALERTAS.datasets,
                'Alertas'
            );

            makeLineMulti(
                mountCardCanvas('ram_2', 'Maiores picos de RAM entre os servidores'),
                RAM_LINHAS.labels,
                RAM_LINHAS.series,
                RAM_LINHAS.linhaAlvo
            );

            makePie(
                mountCardCanvas('ram_3', 'Porcentagem relativa no uso de RAM entre servidores em (período)'),
                RAM_PIZZA.labels,
                RAM_PIZZA.data
            );
        }

        function renderCPU() {
            makeBarGrouped(
                mountCardCanvas('cpu_1', 'Quantidade de alertas de CPU entre os servidores'),
                CPU_ALERTAS.labels,
                CPU_ALERTAS.datasets,
                'Alertas'
            );

            makeLineMulti(
                mountCardCanvas('cpu_2', 'Maiores picos de CPU entre os servidores'),
                CPU_LINHAS.labels,
                CPU_LINHAS.series,
                CPU_LINHAS.linhaAlvo
            );

            makePie(
                mountCardCanvas('cpu_3', 'Porcentagem de proporção relativa no uso de CPU entre servidores em (período)'),
                CPU_PIZZA.labels,
                CPU_PIZZA.data
            );
        }


        document.addEventListener('DOMContentLoaded', () => {
            renderKPIs();
            renderProjecao();
            renderDisco();
            renderRAM();
            renderCPU();
        });
    </script>

</body>