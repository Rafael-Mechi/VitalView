<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>VitalView</title>

  <script src="js/sessao.js"></script>
  <script src="js/cadastro.js"></script>
  <link rel="stylesheet" href="./css/cadastro.css" />
  <link rel="icon" href="./assets/LogoVitalView.png" />
  <link rel="preconnect" href="https://fonts.gstatic.com" />
</head>

<body>

  <header class="escuro">
    <section class="container">

      <nav class="menu">
        <input type="checkbox" name="chk_hamburguer" id="chk_hamburguer" class="check_hamburguer">

        <section class="hamburguer">
            <span class="menu_lateral">
                <div class="icones_topo">
                    <img class="img_hamb" src="assets/LogoVitalView.png" alt="">
                    <img src="./assets/dashboard-icons/layout.svg" alt="">
                    <img src="./assets/dashboard-icons/activity.svg" alt="">
                    <img src="./assets/dashboard-icons/calendar.svg" alt="">
                    <img src="./assets/dashboard-icons/bar-chart.svg" alt="">
                </div>

                <div class="icones_baixo">
                    <img src="./assets/dashboard-icons/settings.svg" alt="">
                    <img src="./assets/dashboard-icons/users.svg" alt="">
                    <img src="./assets/dashboard-icons/help-circle.svg" alt="">
                    <img src="./assets/dashboard-icons/log-out.svg" alt="">
                </div>
            </span>
        </section>
        <ul>
          <div class="title_hamb">
            <img class="img_hamb" src="assets/LogoVitalView.png" alt="">
            <h2 class="hamb_nome">VitalView</h2>
          </div>
          <div class="menu_topo">
            <h3 class="title_menu">Dashboards</h3>
            <li>
              <a href="dashboardAnalista.html"> Dash Analista </a>
            </li>
            <li>
              <a href="dashboardSuporteMacro.html"> Dash Suporte Macro</a>
            </li>
            <li>
              <a href="dashboardSuporteMicro.html"> Dash Suporte Micro</a>
            </li>

          </div>

          <div class="menu_baixo">
            <h3 class="title_menu">Outras Opções</h3>
            <li>
              <a href="cadastro.html"> Cadastro Funcionário </a>
            </li>
            <li>
              <a href="cadastroserver.html"> Cadastro Servidores </a>
            </li>
            <li>
              <a target="_blank"> Central de Serviço </a>
            </li>
            <li>
              <a onclick="limparSessao()"> Sair </a>
            </li>
          </div>
        </ul>
      </nav>

      <section class="secao_logo">
        <h1 class="titulo_header">Cadastro de Funcionários</h1>
      </section>

      <section class="secao_logo">
        <a href="dashboard.html">
          <img src="assets/LogoVitalView.png" alt="Logo VitalView" class="logo">
        </a>
        <div class="linha"></div>
      </section>

    </section>
  </header>


  <div class="container-funcionario">
    <div class="card">
      <div class="formulario">
        <div class="campo">
            <span>Nome:</span>
            <input id="nome_input" type="text" placeholder="Seu nome" />
          </div>
          <div class="campo">
            <span>CPF:</span>
            <input id="cpf_input" type="text" placeholder="Seu cpf" />
          </div>
          <div class="campo">
            <span>Telefone:</span>
            <input id="telefone_input" type="text" placeholder="Seu telefone" />
          </div>
      </div>
    </div>

    <div class="card">
      <div class="formulario">  
        <div class="campo">
            <span>E-mail:</span>
            <input id="email_input" type="text" placeholder="meuemail@provedor.com" />
          </div>
          <div class="campo">
            <span>Senha:</span>
            <input id="senha_input" type="password" placeholder="******" />
          </div>
          <div class="campo">
            <span>Confirmação da Senha:</span>
            <input id="confirmacao_senha_input" type="password" placeholder="******" />
          </div>

          <div class="campo">
            <span>Cargo:</span>
            <select name="" id="cargo_input" onchange="mostrar()">
              <option value="">Escolha uma opção</option>
            </select>
          </div>

          <div class="form-actions">
            <button type="reset" class="btn cancel" onclick="limparFormulario()">Limpar</button>
            <button type="submit" class="btn save" onclick="cadastrar()">Cadastrar</button>
          </div>
      </div>
    </div>
  </div>

  <div id="div_resposta"></div>

  <script>

    function limparFormulario() {
    const campos = document.querySelectorAll('.container-funcionario input, .container-funcionario select');

    campos.forEach(campo => {
      campo.value = '';
    });
}


    async function fetchJsonOrThrow(url, options) {
      const res = await fetch(url, options);
      const text = await res.text();

      if (!res.ok) {
        console.error(`Erro HTTP ${res.status} em ${url}:`, text);
        throw new Error(`(${res.status}) Falha ao acessar ${url}`);
      }

      try {
        return JSON.parse(text);
      } catch (e) {
        console.error(`Resposta não-JSON de ${url}:`, text);
        throw new Error(`Resposta inválida do servidor em ${url} (esperava JSON)`);
      }
    }

    function sumirMensagem() {
      const cardErro = document.getElementById('cardErro');
      if (cardErro) cardErro.style.display = 'none';
    }


    let listaEmpresasCadastradas = [];
    let listaHospitais = [];
    let listaCargos = [];


    function listarEmpresas() {

      fetchJsonOrThrow('/usuarios/autenticar')
        .then(empresas => {
          listaEmpresasCadastradas = Array.isArray(empresas) ? empresas : [];

        })
        .catch(err => {
          console.error(err);
          mostrarErro('Erro ao carregar empresas.');
        });
    }

    function carregarHospitais() {

      fetchJsonOrThrow('/usuarios/procurarHospitais')
        .then(lista => {
          listaHospitais = Array.isArray(lista) ? lista : [];
          const sel = document.getElementById('hospital_input');
          if (!sel) return;
          sel.innerHTML = '<option value="">Escolha uma opção</option>';
          listaHospitais.forEach(h => {
            sel.innerHTML += `<option value="${h.idhospital}">${h.nome}</option>`;
          });
        })
        .catch(err => {
          console.error(err);
          mostrarErro('Erro ao carregar hospitais.');
        });
    }

    function carregarCargos() {

      fetchJsonOrThrow('/usuarios/procurarCargos')
        .then(lista => {
          listaCargos = Array.isArray(lista) ? lista : [];
          const sel = document.getElementById('cargo_input');
          if (!sel) return;
          sel.innerHTML = '<option value="">Escolha uma opção</option>';
          listaCargos.forEach(c => {
            sel.innerHTML += `<option value="${c.idcargo}">${c.nome}</option>`;
          });
        })
        .catch(err => {
          console.error(err);
          mostrarErro('Erro ao carregar cargos.');
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
      listarEmpresas();
      carregarHospitais();
      carregarCargos();
    });

    // Cadastro 
    async function cadastrar() {

      if (typeof mostrarAguardar === 'function') mostrarAguardar();

      const nomeVar = (document.getElementById('nome_input')?.value || '').trim();
      const emailVar = (document.getElementById('email_input')?.value || '').trim();
      const senhaVar = (document.getElementById('senha_input')?.value || '').trim();
      const confirmacaoVar = (document.getElementById('confirmacao_senha_input')?.value || '').trim();
      const cpfVar = (document.getElementById('cpf_input')?.value || '').trim();
      const telefoneVar = (document.getElementById('telefone_input')?.value || '').trim();
      const codigoVar = (document.getElementById('codigo_input')?.value || '').trim();
      const hospitalVar = (document.getElementById('hospital_input')?.value || '').trim();
      const cargoVar = (document.getElementById('cargo_input')?.value || '').trim();

      const cardErro = document.getElementById('cardErro');
      const mensagem_erro = document.getElementById('mensagem_erro');


      function falha(msg) {
        if (cardErro) cardErro.style.display = 'block';
        if (mensagem_erro) mensagem_erro.innerHTML = msg;
        if (typeof esconderAguardar === 'function') esconderAguardar();
        setTimeout(sumirMensagem, 5000);
        return false;
      }

      if (!nomeVar || !emailVar || !senhaVar || !confirmacaoVar || !cpfVar || !codigoVar || !hospitalVar || !cargoVar) {
        return falha('(Preencha todos os campos)');
      } else if (nomeVar.length <= 1) {
        return falha('(Digite um nome válido)');
      } else if (!emailVar.includes('@') || !emailVar.includes('.')) {
        return falha('(E-mail deve conter @ e .)');
      } else if (senhaVar.length <= 3) {
        return falha('(Senha tem que ser maior que 3 dígitos)');
      } else if (cpfVar.length !== 11 || !/^\d{11}$/.test(cpfVar)) {
        return falha('(CPF deve ter 11 dígitos numéricos)');
      } else if (confirmacaoVar !== senhaVar) {
        return falha('(Senhas estão diferentes)');
      }


      let idEmpresaVincular = null;
      if (listaEmpresasCadastradas.length > 0) {
        const empresa = listaEmpresasCadastradas.find(e => String(e.codigo_ativacao) === String(codigoVar));
        if (!empresa) {
          return falha('(Código de ativação inválido)');
        }
        idEmpresaVincular = empresa.id;
      } else {

        console.warn('listaEmpresasCadastradas vazia — validando no backend.');
      }

      try {

        const payload = {
          nome: nomeVar,
          email: emailVar,
          senha: senhaVar,
          cpf: cpfVar,
          telefone: telefoneVar,
          codigo: codigoVar,
          hospital: hospitalVar,
          cargo: cargoVar,
          idEmpresaVincular

        };

        const res = await fetch('/usuarios/cadastrar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const texto = await res.text();

        if (!res.ok) {
          console.error('Erro no cadastro:', texto);
          throw new Error('Houve um erro ao tentar realizar o cadastro!');
        }


        try { JSON.parse(texto); } catch (_) { }

        if (cardErro) cardErro.style.display = 'block';
        if (mensagem_erro) {
          mensagem_erro.innerHTML = 'Cadastro realizado com sucesso! Redirecionando para tela de Login...';
        }

        setTimeout(() => { window.location = 'login.html'; }, 2000);


        if (typeof limparFormulario === 'function') limparFormulario();

      } catch (err) {
        console.error(err);
        mostrarErro(err.message || 'Erro ao cadastrar.');
      } finally {
        if (typeof esconderAguardar === 'function') esconderAguardar();
      }

      return false;
    }
  </script>

</body>

</html>