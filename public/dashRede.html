<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Rede</title>
    <link rel="stylesheet" href="css/dashRede.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="js/sessao.js"></script>
</head>

<body>

    <nav class="menu">
        <input type="checkbox" name="chk_hamburguer" id="chk_hamburguer" class="check_hamburguer">

        <section class="hamburguer">
            <span class="menu_lateral">
                <div class="icones_topo">
                    <img class="img_hamb" src="assets/LogoVitalView.png">
                    <img src="./assets/dashboard-icons/activity.svg" data-role="Analista,Administrador">
                    <img src="./assets/dashboard-icons/bar-chart.svg" data-role="T√©cnico,Administrador">
                    <img src="./assets/dashboard-icons/layout.svg" data-role="T√©cnico,Administrador">
                </div>

                <div class="icones_baixo">
                    <img src="./assets/dashboard-icons/gerenciar-usuarios.png" data-role="Administrador"
                        style="width: 28px; height: 28px;">
                    <img src="./assets/dashboard-icons/calendar.svg" data-role="Analista,T√©cnico,Administrador">
                    <img src="./assets/dashboard-icons/users.svg" data-role="Administrador">
                    <img src="./assets/dashboard-icons/hard-drive.svg" data-role="T√©cnico,Administrador">
                    <img src="./assets/dashboard-icons/help-circle.svg" data-role="Analista,T√©cnico,Administrador">
                    <img src="./assets/dashboard-icons/log-out.svg" data-role="Analista,T√©cnico,Administrador">
                </div>
            </span>
        </section>

        <ul>
            <div class="title_hamb">
                <img class="img_hamb" src="assets/LogoVitalView.png" alt="">
                <h2 class="hamb_nome">VitalView</h2>
            </div>
            <div class="menu_topo">
                <h3 class="title_menu">Dashboards</h3>
                <li style="display: flex; align-items: center;" data-role="Analista,Administrador,T√©cnico">
                    <img src="./assets/dashboard-icons/home.svg" style="width: 20px; margin-right: 4px;"><a
                        href="bemVindo.html">Home</a>
                </li>
                <li style="display: flex; align-items: center;" data-role="Analista,Administrador" class="pagina-ativa">
                    <img src="./assets/dashboard-icons/activity.svg" style="width: 20px; margin-right: 4px;"><a
                        href="dashboardAnalista.html">Dash Analista</a>
                </li>
                <li style="display: flex; align-items: center;" data-role="T√©cnico,Administrador"><img
                        src="./assets/dashboard-icons/bar-chart.svg" style="width: 20px; margin-right: 4px;"><a
                        href="dashboardSuporteMacro.html">Dash Suporte Macro</a></li>
                <li style="display: flex; align-items: center;" data-role="T√©cnico,Administrador"><img
                        src="./assets/dashboard-icons/layout.svg" style="width: 20px; margin-right: 4px;"><a
                        href="dashboardSuporteMicro.html">Dash Suporte Micro</a></li>
                <li style="display: flex; align-items: center;" data-role="T√©cnico,Administrador">
                    <img src="./assets/dashboard-icons/wifi (1).svg" style="width: 20px; margin-right: 4px;"><a
                        href="dashRede.html">Dashboard Rede</a>
                </li>
            </div>

            <div class="menu_baixo">
                <h3 class="title_menu">Outras Op√ß√µes</h3>
                <li style="display: flex; align-items: center;" data-role="Administrador"><img
                        src="./assets/dashboard-icons/gerenciar-usuarios.png" style="width: 20px; margin-right: 4px;"><a
                        href="dashControleSistema.html">Gerenciar usu√°rios</a></li>
                <li style="display: flex; align-items: center;" data-role="Analista,T√©cnico,Administrador"><img
                        src="./assets/dashboard-icons/calendar.svg" style="width: 20px; margin-right: 4px;"><a
                        href="historicoAlertas.html">Hist√≥rico de Alertas</a></li>
                <li style="display: flex; align-items: center;" data-role="Administrador"><img
                        src="./assets/dashboard-icons/users.svg" style="width: 20px; margin-right: 4px;"><a
                        href="cadastroFuncionarios.html">Cadastro Funcion√°rio</a></li>
                <li style="display: flex; align-items: center;" data-role="T√©cnico,Administrador"><img
                        src="./assets/dashboard-icons/hard-drive.svg" style="width: 20px; margin-right: 4px;"><a
                        href="cadastroServidores.html">Cadastro Servidores</a></li>
                <li style="display: flex; align-items: center;" data-role="Analista,T√©cnico,Administrador"><img
                        src="./assets/dashboard-icons/help-circle.svg" style="width: 20px; margin-right: 4px;"><a
                        href="https://vitalviewsptech.atlassian.net/servicedesk/customer/portal/1"
                        target="_blank">Central de Servi√ßo</a></li>
                <li style="display: flex; align-items: center;" data-role="Analista,T√©cnico,Administrador"><img
                        src="./assets/dashboard-icons/log-out.svg" style="width: 20px; margin-right: 4px;"><a
                        onclick="limparSessao()">Sair</a></li>
            </div>
        </ul>
    </nav>

    <section class="container">
        <section class="nav-dash">
            <section class="secao_logo">
                <a href="dashboardAnalista.html">
                    <img src="assets/LogoVitalView.png" alt="Logo VitalView" class="logo">
                </a>
            </section>

            <section class="secao_logo">
                <h1 class="titulo_header" style="margin-left: 10px;">VitalView</h1>
            </section>

            <section class="secao_logo" id="escolher-servidor">
                <select class="periodo_select" name="periodo" id="periodo_select">
                    <option value="1">Escolher Servidor</option>
                    <option value="2">Servidor 1</option>
                    <option value="3">Servidor 2</option>
                    <option value="4">Servidor 3</option>
                    <option value="5">Servidor 4</option>
                    <option value="6">Servidor 5</option>
                </select>
            </section>
        </section>

        <main class="grid">
            <div class="parteCima">

                <section class="card kpi pacotes">
                    <h3>Perda de Pacotes <button type="button" class="infoBtn"
                            data-target="infoPerdaPacote">&#9432</button></h3>
                    <div class="caption">Percentual (%)</div>
                    <div class="kpi-number" id="loss-pct">--%</div>
                    <div class="badge" id="loss-status">--</div>
                </section>

                <div id="infoPerdaPacote" class="modal">
                    <div class="modal-content">
                        <h3>Perda de Pacotes</h3>
                        <br>
                        <p style="text-align: center; font-size: 20px;">
                            Tr√°s a porcent√°gem (%) de perda de pacotes durante o tr√°fego de rede:<br><br>
                            &lt; 20%: <span style="color: #32b9cd;"><b>Normal</b></span><br>
                            &gt; 30%: <span style="color: #f75454;"><b>Alerta</b></span>
                        </p>
                        <button type="button" class="closeBtn">Fechar</button>
                    </div>
                </div>

                <section class="card kpi conexoes">
                    <h3>Conex√µes <button type="button" class="infoBtn" data-target="infoConexao">&#9432</button></h3>
                    <div class="caption">Conex√µes ativas</div>
                    <div class="kpi-number" id="conexoes-ativas">39</div>
                    <div class="badge" id="conexoes-status">Normal</div>
                </section>

                <div id="infoConexao" class="modal">
                    <div class="modal-content">
                        <h3>Conex√µes Ativas</h3>
                        <br>
                        <p style="text-align: center; font-size: 20px;">
                            Tr√°s o n√∫mero de conex√µes ativas na rede do servidor:<br><br>
                            &lt; 50: <span style="color: #32b9cd;"><b>Normal</b></span><br>
                            &gt; 60: <span style="color: #f75454;"><b>Alerta</b></span>
                        </p>
                        <button type="button" class="closeBtn">Fechar</button>
                    </div>
                </div>

                <section class="card latencia">
                    <h3>Lat√™ncia <button type="button" class="infoBtn" data-target="infoLat">&#9432</button></h3>
                    <div class="caption">Tempo de resposta (ms)</div>
                    <div class="kpi-number" id="latencia-atual">--</div>
                    <div class="badge" id="latencia-status">--</div>
                </section>

                <div id="infoLat" class="modal">
                    <div class="modal-content">
                        <h3>Lat√™ncia</h3>
                        <br>
                        <p style="text-align: center; font-size: 20px;">
                            Mostra qual √© a lat√™ncia em milissegundos (ms) ou seja o tempo que uma requisi√ß√£o leva para
                            chegar no servidor:<br><br>
                            &lt; 30ms: <span style="color: #32b9cd;"><b>Normal</b></span><br>
                            &gt; 40ms: <span style="color: #f75454;"><b>Alerta</b></span>
                        </p>
                        <button type="button" class="closeBtn">Fechar</button>
                    </div>
                </div>

            </div>

            <div class="parteBaixo">
                <section class="card trafego">
                    <h3>Velocidade de Tr√°fego de Rede <button type="button" class="infoBtn"
                            data-target="infoVelocidade">&#9432</button></h3>
                    <div class="caption">(Megabits por segundo)</div>

                    <div class="row">
                        <div class="kpi">
                            <strong>Download</strong>
                        </div>
                        <div class="bar-wrap" aria-label="barra download">
                            <div class="bar" id="bar-down"></div>
                        </div>
                        <div class="value"> <span id="val-down">87</span> Mbps</div>
                        <div class="badge" style="position:static; transform:none; margin-left:8px" id="down-status">
                            Normal
                        </div>
                    </div>

                    <div class="row">
                        <div class="kpi">
                            <strong>Upload</strong>
                        </div>
                        <div class="bar-wrap" aria-label="barra upload">
                            <div class="bar alerta" id="bar-up"></div>
                        </div>
                        <div class="value"> <span id="val-up">18</span> Mbps</div>
                        <div class="badge alerta" style="position:static; transform:none; margin-left:8px"
                            id="up-status">
                            Alerta
                        </div>
                    </div>
                </section>

                <div id="infoVelocidade" class="modal">
                    <div class="modal-content">
                        <h3>Velocidade de Tr√°fego de Rede</h3>
                        <br>
                        <p style="text-align: center; font-size: 20px;">
                            Mostra e compara a velocidade de Download e Upload dos dados no servidor em Megabits po
                            segundo (Mbps):<br><br>
                            &lt; 70 Mbps: <span style="color: #32b9cd;"><b>Normal</b></span><br>
                            &gt; 30 Mbps: <span style="color: #f75454;"><b>Alerta</b></span>
                        </p>
                        <button type="button" class="closeBtn">Fechar</button>
                    </div>
                </div>

                <section class="card entrada">
                    <h3>Pacotes Enviados e Recebidos <button type="button" class="infoBtn"
                            data-target="infoEnvRec">&#9432</button></h3>
                    <div class="caption">(Quantidade de pacotes IN/OUT)</div>
                    <div class="chart-box">
                        <canvas id="ioChart"></canvas>
                    </div>
                    <div class="badge">Normal</div>
                </section>

                <div id="infoEnvRec" class="modal">
                    <div class="modal-content">
                        <h3>Pacotes Enviados e Recebidos</h3>
                        <br>
                        <p style="text-align: center; font-size: 20px;">
                            Tr√°s a compara√ß√£o entre quantidade de pacotes enviados e recebidos em um gr√°fico de linhas
                            ao longo do dia:<br><br>
                            &lt; 50%: <span style="color: #32b9cd;"><b>Normal</b></span><br>
                            &gt; 60%: <span style="color: #f75454;"><b>Alerta</b></span>
                        </p>
                        <button type="button" class="closeBtn">Fechar</button>
                    </div>
                </div>
            </div>
        </main>

    </section>

    <script src="js/permissoes.js"></script>

    <script>
        // modais do Meki üíÖüèª
        let infoBtns = document.querySelectorAll('.infoBtn');
        let modals = document.querySelectorAll('.modal');
        let closeBtns = document.querySelectorAll('.closeBtn');

        infoBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                let target = btn.dataset.target;
                document.getElementById(target).style.display = 'flex';
            });
        });

        closeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('.modal').style.display = 'none';
            });
        });

        modals.forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.style.display = 'none';
            });
        });

        // my permissions bitch üíÖüèª
        if (typeof protegerPagina === 'function') protegerPagina(['T√©cnico', 'Administrador']);
        if (typeof aplicarCargoNaUI === 'function') aplicarCargoNaUI();

        // Utilit√°rios dos gr√°ficos
        const teal = '#14b8a6';
        const teal2 = '#0ea5e9';

        function setBadge(el, status, numberEl) {
            el.classList.remove('ok', 'alerta');
            if (status === 'Alerta') el.classList.add('alerta');
            if (status === 'Normal') el.classList.add('ok');
            el.textContent = status;

            if (numberEl) {
                numberEl.classList.remove('ok', 'alerta');
                if (status === 'Alerta') numberEl.classList.add('alerta');
                if (status === 'Normal') numberEl.classList.add('ok');
            }
        }

        function setBar(el, value, max) {
            const pct = Math.max(0, Math.min(100, (value / max) * 100));
            el.style.width = pct + '%';
            el.setAttribute('aria-valuenow', value);
        }

        // Varia√ß√£o dos dados mocados
        function jitter(base, maxStep, min = 0, max = Infinity) {
            const v = base + (Math.random() * 2 - 1) * maxStep;
            return Math.max(min, Math.min(max, v));
        }

        // Dados pr√© mocados
        const CAPACIDADE_BANDA = 300;
        const MAX_PONTOS = 12;

        const METRICAS = {
            pacotesPerdidos: 1,
            conexoesAtivas: 38,
            banda: { capacidade: CAPACIDADE_BANDA, usadaDown: 85, usadaUp: 18 },
            ping: {
                rttMsAtual: 23,
                enviados: 10,
                perdidos: 1
            }
        };

        // Elementos 
        const latNow = document.getElementById('latencia-atual');
        const latBadge = document.getElementById('latencia-status');

        const lossPctEl = document.getElementById('loss-pct');
        const lossBadge = document.getElementById('loss-status');

        const conVal = document.getElementById('conexoes-ativas');
        const conBadge = document.getElementById('conexoes-status');

        const barDown = document.getElementById('bar-down');
        const barUp = document.getElementById('bar-up');
        const valDownEl = document.getElementById('val-down');
        const valUpEl = document.getElementById('val-up');
        const downBadge = document.getElementById('down-status');
        const upBadge = document.getElementById('up-status');

        // Gr√°fico entrada e sa√≠da
        const ioCanvas = document.getElementById('ioChart');
        let ioChart = null;

        function initChart() {
            if (!ioCanvas || !window.Chart) return;

            const agora = () => new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            const ioLabels = Array.from({ length: 5 }, (_, i) => agora());
            const entrada = [40, 80, 10, 25, 40];
            const saida = [10, 30, 5, 12, 30];

            ioChart = new Chart(ioCanvas, {
                type: 'line',
                data: {
                    labels: ioLabels,
                    datasets: [
                        { label: 'Entrada', data: entrada, borderColor: teal2, backgroundColor: teal2, tension: .35, pointRadius: 3, fill: false },
                        { label: 'Sa√≠da', data: saida, borderColor: teal, backgroundColor: teal, tension: .35, pointRadius: 3, fill: false }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: '#eef2f7' } } },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }

        function pushChartPoint(inVal, outVal) {
            if (!ioChart) return;
            const label = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            ioChart.data.labels.push(label);
            ioChart.data.datasets[0].data.push(inVal);
            ioChart.data.datasets[1].data.push(outVal);

            while (ioChart.data.labels.length > MAX_PONTOS) {
                ioChart.data.labels.shift();
                ioChart.data.datasets.forEach(d => d.data.shift());
            }
            ioChart.update();
        }

        // KPI: Conex√µes
        function renderKPIs() {
            // Lat√™ncia
            if (latNow && latBadge) {
                latNow.textContent = Math.round(METRICAS.ping.rttMsAtual) + ' ms';
                setBadge(latBadge, METRICAS.ping.rttMsAtual <= 80 ? 'Normal' : 'Alerta', latNow);
            }

            // Perda de Pacotes (%)
            if (lossPctEl && lossBadge) {
                const perdaPct = METRICAS.ping.enviados > 0
                    ? (METRICAS.ping.perdidos / METRICAS.ping.enviados) * 100
                    : 0;
                lossPctEl.textContent = perdaPct.toFixed(1) + '%';
                setBadge(lossBadge, perdaPct < 5 ? 'Normal' : 'Alerta', lossPctEl);
            }

            // Conex√µes
            if (conVal && conBadge) {
                conVal.textContent = Math.round(METRICAS.conexoesAtivas);
                const ok = METRICAS.conexoesAtivas >= 10 && METRICAS.conexoesAtivas <= 200;
                setBadge(conBadge, ok ? 'Normal' : 'Alerta', conVal);
            }

            // Barras Download/Upload
            if (barDown && barUp && valDownEl && valUpEl && downBadge && upBadge) {
                const down = Math.round(METRICAS.banda.usadaDown);
                const up = Math.round(METRICAS.banda.usadaUp);

                setBar(barDown, down, 100);
                setBar(barUp, up, 100);

                valDownEl.textContent = down;
                valUpEl.textContent = up;

                setBadge(downBadge, down >= 70 ? 'Normal' : 'Alerta');
                setBadge(upBadge, up >= 30 ? 'Normal' : 'Alerta');
            }
        }

        // SIMULA√á√ÉO DE DADOS
        function tickMock() {
            // Lat√™ncia varia suavemente entre 15 e 120 ms
            METRICAS.ping.rttMsAtual = jitter(METRICAS.ping.rttMsAtual, 6, 15, 120);

            // Pacotes enviados/perdidos
            METRICAS.ping.enviados = Math.max(1, Math.round(jitter(METRICAS.ping.enviados, 2, 5, 30)));
            METRICAS.ping.perdidos = Math.round(Math.max(0, Math.min(METRICAS.ping.enviados, jitter(METRICAS.ping.perdidos, 1, 0, 5))));

            // Conex√µes ativas
            METRICAS.conexoesAtivas = Math.round(jitter(METRICAS.conexoesAtivas, 5, 12, 220));

            // Consumo de banda simulado (Mbps)
            METRICAS.banda.usadaDown = jitter(METRICAS.banda.usadaDown, 10, 10, 100);
            METRICAS.banda.usadaUp = jitter(METRICAS.banda.usadaUp, 5, 2, 100);

            // Gr√°fico IN/OUT
            const inPkts = Math.round(jitter(70, 25, 5, 140));
            const outPkts = Math.round(jitter(40, 20, 3, 100));
            pushChartPoint(inPkts, outPkts);

            renderKPIs();
        }

        initChart();
        renderKPIs();
        const TIMER_MS = 2000; // 2s
        const timerId = setInterval(tickMock, TIMER_MS);

    </script>

</body>

</html>