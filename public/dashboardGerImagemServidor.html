<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de imagens</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="css/dashGerImagemServ.css">
    <script src="js/sessao.js"></script>
</head>

<body onload="carregarInformacoes()">
    <nav class="menu">
        <input type="checkbox" name="chk_hamburguer" id="chk_hamburguer" class="check_hamburguer">

        <section class="hamburguer">
            <span class="menu_lateral">
                <div class="icones_topo">
                    <img class="img_hamb" src="assets/LogoVitalView.png">
                    <img src="./assets/dashboard-icons/activity.svg" data-role="Analista,Administrador">
                    <img src="./assets/dashboard-icons/bar-chart.svg" data-role="Técnico,Administrador">
                    <img src="./assets/dashboard-icons/layout.svg" data-role="Técnico,Administrador">
                </div>

                <div class="icones_baixo">
                    <img src="./assets/dashboard-icons/gerenciar-usuarios.png" data-role="Administrador"
                        style="width: 28px; height: 28px;">
                    <img src="./assets/dashboard-icons/calendar.svg" data-role="Analista,Técnico,Administrador">
                    <img src="./assets/dashboard-icons/users.svg" data-role="Administrador">
                    <img src="./assets/dashboard-icons/hard-drive.svg" data-role="Técnico,Administrador">
                    <img src="./assets/dashboard-icons/help-circle.svg" data-role="Analista,Técnico,Administrador">
                    <img src="./assets/dashboard-icons/log-out.svg" data-role="Analista,Técnico,Administrador">
                </div>
            </span>
        </section>

        <ul>
            <div class="title_hamb">
                <img class="img_hamb" src="assets/LogoVitalView.png" alt="">
                <h2 class="hamb_nome">VitalView</h2>
            </div>
            <div class="menu_topo">
                <h3 class="title_menu">Dashboards</h3>
                <li style="display: flex; align-items: center;" data-role="Analista,Administrador,Técnico">
                    <img src="./assets/dashboard-icons/home.svg" style="width: 20px; margin-right: 4px;"><a
                        href="bemVindo.html">Home</a>
                </li>
                <li style="display: flex; align-items: center;" data-role="Analista,Administrador">
                    <img src="./assets/dashboard-icons/activity.svg" style="width: 20px; margin-right: 4px;"><a
                        href="dashboardAnalista.html">Dash Analista</a>
                </li>
                <li style="display: flex; align-items: center;" data-role="Técnico,Administrador"><img
                        src="./assets/dashboard-icons/bar-chart.svg" style="width: 20px; margin-right: 4px;"><a
                        href="dashboardSuporteMacro.html">Dash Suporte Macro</a></li>
                <li style="display: flex; align-items: center;" data-role="Técnico,Administrador"><img
                        src="./assets/dashboard-icons/layout.svg" style="width: 20px; margin-right: 4px;"><a
                        href="dashboardSuporteMicro.html">Dash Suporte Micro</a></li>
                <li style="display: flex; align-items: center;" data-role="Técnico,Administrador">
                    <img src="./assets/dashboard-icons/wifi (1).svg" style="width: 20px; margin-right: 4px;"><a
                        href="dashRede.html">Dashboard Rede</a>
                </li>
            </div>

            <div class="menu_baixo">
                <h3 class="title_menu">Outras Opções</h3>
                <li style="display: flex; align-items: center;" data-role="Administrador" class="pagina-ativa"><img
                        src="./assets/dashboard-icons/gerenciar-usuarios.png" style="width: 20px; margin-right: 4px;"><a
                        href="dashControleSistema.html">Gerenciar usuários</a></li>
                <li style="display: flex; align-items: center;" data-role="Analista,Técnico,Administrador"><img
                        src="./assets/dashboard-icons/calendar.svg" style="width: 20px; margin-right: 4px;"><a
                        href="historicoAlertas.html">Histórico de Alertas</a></li>
                <li style="display: flex; align-items: center;" data-role="Administrador"><img
                        src="./assets/dashboard-icons/users.svg" style="width: 20px; margin-right: 4px;"><a
                        href="cadastroFuncionarios.html">Cadastro Funcionário</a></li>
                <li style="display: flex; align-items: center;" data-role="Técnico,Administrador"><img
                        src="./assets/dashboard-icons/hard-drive.svg" style="width: 20px; margin-right: 4px;"><a
                        href="cadastroServidores.html">Cadastro Servidores</a></li>
                <li style="display: flex; align-items: center;" data-role="Analista,Técnico,Administrador"><img
                        src="./assets/dashboard-icons/help-circle.svg" style="width: 20px; margin-right: 4px;"><a
                        href="https://vitalviewsptech.atlassian.net/servicedesk/customer/portal/1"
                        target="_blank">Central de Serviço</a></li>
                <li style="display: flex; align-items: center;" data-role="Analista,Técnico,Administrador"><img
                        src="./assets/dashboard-icons/log-out.svg" style="width: 20px; margin-right: 4px;"><a
                        onclick="limparSessao()">Sair</a></li>
            </div>
        </ul>
    </nav>

    <section class="container">
        <section class="nav-dash">
            <section class="secao_logo">
                <a href="dashboardAnalista.html">
                    <img src="assets/LogoVitalView.png" alt="Logo VitalView" class="logo">
                </a>
            </section>
            <section class="secao_logo">
                <h1 class="titulo_header">VitalView</h1>
            </section>
        </section>

        <div class="container-principal">
            <div class="container-graficos">
    <div class="kpi">
        <h2 class="normal">Imagem mais pesada:</h2>
        <div class="sub">Em megabytes</div>
        <div class="value">gato-siames.jpg - 1.27MB</div>
    </div>

    <div class="kpi">
        <div class="kpi-badge"><span style="color: #32b9cd;">Estável</span></div>
        <h2 class="normal">Crescimento médio de imagens <button type="button" class="infoBtn"
                            data-target="infoCrescimentoImagem">&#9432</button></h3></h2>
        <div class="sub">Imagens por mês</div>
        <div class="value">140</div>
    </div>

    <div class="kpi">
        <div class="kpi-badge"><span style="color: #ef4444;">Atenção</span></div>
        <h2 class="normal">Tamanho médio das imagens <button type="button" class="infoBtn"
                            data-target="infoCrescimentoImagem">&#9432</button></h2>
        <div class="sub">Tamanho médio por imagem</div>
        <div class="value"><span style="color: #ef4444;">3MB</span></div>
    </div>
</div>

            <div class="tabela-alertas">
                <div class="tabela-header">
                    <div>
                        <h2>Imagens que podem ser removidas: <b>3</b></h2>
                    </div>
                    <div class="div_filtro">
                        <span>Filtrar por:</span>
                        <select class="filtro-select" id="filtro">
                            <option value="idUsuario">servidor</option>
                            <option value="nome">nome do arquivo</option>
                            <option value="cargo">tamanho</option>
                            <option value="data_criacao">data de geração</option>
                            <option value="data_criacao">tempo no sistema</option>
                        </select>
                    </div>
                </div>

                <div class="tabela-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th id="th-sup-esquerdo">Nome do arquivo</th>
                                <th>Tamanho</th>
                                <th>Data de geração</th>
                                <th >Tempo no sistema</th>
                                <th id="th-sup-direito">Excluir</th>
                            </tr>
                        </thead>
                        <tbody id="info-imagens">
                            
                        </tbody>
                    </table>
                </div>

                <div class="div_grafico">
                    <canvas id="grafico-linha"></canvas>
                </div>
            </div>
        </div>
    </section>

    <script>
        let idHospitalVar = sessionStorage.FK_HOSPITAL;
        let idUsuario = sessionStorage.ID_USUARIO;

        let key = "suporte/gerenciamento-imagens/1_srv1_hsl.json";
        let key2 = "1_srv1_hsl.json";

        function carregarInformacoes() {
            fetch(`/ger-imagem/buscar-dados-bucket/${encodeURIComponent(key)}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                }
            })
                .then(response => {
                    if (response.ok) {
                        response.json().then(resposta => {
                            console.log("Dado recebido: ", resposta);
                            gerarTabelaImagens(resposta);
                        })
                    }
                })
                .catch((erro) => {
                    console.error("Erro na requisição: ", erro);
                    alert("Erro na conexão com o servidor.");
                });
        }

        function gerarTabelaImagens(dados) {
            let tbodyImagens = document.getElementById("info-imagens");
            tbodyImagens.innerHTML = "";

            let caminhoImagem;
            let nomeArquivo;
            let tamanho;
            let dataGeracao;
            let tempoNoSistema;

            for(let i = 0; i < dados.length; i++){
                let registro = dados[i];

                caminhoImagem = registro.caminho_arquivo;
                nomeArquivo = registro.nome_arquivo;
                tamanho = registro.tamanho;
                dataGeracao = registro.data_geracao;
                tempoNoSistema = registro.anos_no_sistema;

                let linha = `
                <tr>
                    <td hidden>${caminhoImagem}</td>
                    <td>${nomeArquivo}</td>
                    <td>${tamanho} MB</td>
                    <td>${dataGeracao}</td>
                    <td>${tempoNoSistema} anos</td>
                    <td class="acao-icons">
                        <button class="btn-excluir-usuario" onclick="excluirImagem(this)">&#x1F5D1;</button>
                    </td>
                </tr>
                `
                
                tbodyImagens.innerHTML += linha;
            }
        }

        function excluirImagem(botao){
            
            let linha = botao.closest("tr");
            let colunas = linha.querySelectorAll("td");

            let caminhoArquivo = colunas[0].textContent;
            let tempoNoSistema = colunas[3].textContent;
            
            fetch(`jira/abrir-chamado-exclusao`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    caminhoArquivoServer: caminhoArquivo,
                    tempoNoSistemaServer: tempoNoSistema
                })
            }).then(function (resposta) {
                if (resposta.ok) {
                    console.log(resposta);
                    alert(`Chamado para exclusão aberta com sucesso!`)
                }

            }).catch(function (erro) {
                console.log(erro);
            })
        }

        const labels = [
            'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
            'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'
        ];

        const dataA = [420, 480, 550, 610, 680, 740, 800, 850, 900, 940, 970, 1000];

        const ctx = document.getElementById('grafico-linha').getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'srv1',
                    data: dataA,
                    borderColor: '#1ECBE1',
                    backgroundColor: 'rgba(255, 0, 0, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Crescimento de Imagens - srv1',
                        color: 'white',
                        font: {
                            size: 20,
                            family: 'Barlow, sans-serif',
                            weight: 'bold'
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: 'white',
                            font: {
                                family: 'Barlow, sans-serif'
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        min: 0,
                        max: 1000,
                        ticks: {
                            color: 'white',
                            font: {
                                family: 'Barlow, sans-serif'
                            }
                        },
                        title: {
                            display: false
                        },
                        grid: {
                            color: 'rgba(255,255,255,0.2)'
                        }
                    },
                    x: {
                        ticks: {
                            color: 'white',        // <<< números/nomes do eixo X
                            font: {
                                family: 'Barlow, sans-serif'
                            }
                        },
                        grid: {
                            color: 'rgba(255,255,255,0.2)'
                        }
                    }
                }
            }

        });
    </script>
</body>

</html>