<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de imagens</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="css/dashGerImagemServ.css">
    <script src="js/sessao.js"></script>
</head>

<body onload="carregarInformacoes()">
    <nav class="menu">
        <input type="checkbox" name="chk_hamburguer" id="chk_hamburguer" class="check_hamburguer">

        <section class="hamburguer">
            <span class="menu_lateral">
                <div class="icones_topo">
                    <img class="img_hamb" src="assets/LogoVitalView.png">
                    <img src="./assets/dashboard-icons/activity.svg" data-role="Analista,Administrador">
                    <img src="./assets/dashboard-icons/bar-chart.svg" data-role="Técnico,Administrador">
                    <img src="./assets/dashboard-icons/layout.svg" data-role="Técnico,Administrador">
                </div>

                <div class="icones_baixo">
                    <img src="./assets/dashboard-icons/gerenciar-usuarios.png" data-role="Administrador"
                        style="width: 28px; height: 28px;">
                    <img src="./assets/dashboard-icons/calendar.svg" data-role="Analista,Técnico,Administrador">
                    <img src="./assets/dashboard-icons/users.svg" data-role="Administrador">
                    <img src="./assets/dashboard-icons/hard-drive.svg" data-role="Técnico,Administrador">
                    <img src="./assets/dashboard-icons/help-circle.svg" data-role="Analista,Técnico,Administrador">
                    <img src="./assets/dashboard-icons/log-out.svg" data-role="Analista,Técnico,Administrador">
                </div>
            </span>
        </section>

        <ul>
            <div class="title_hamb">
                <img class="img_hamb" src="assets/LogoVitalView.png" alt="">
                <h2 class="hamb_nome">VitalView</h2>
            </div>
            <div class="menu_topo">
                <h3 class="title_menu">Dashboards</h3>
                <li style="display: flex; align-items: center;" data-role="Analista,Administrador,Técnico">
                    <img src="./assets/dashboard-icons/home.svg" style="width: 20px; margin-right: 4px;"><a
                        href="bemVindo.html">Home</a>
                </li>
                <li style="display: flex; align-items: center;" data-role="Analista,Administrador">
                    <img src="./assets/dashboard-icons/activity.svg" style="width: 20px; margin-right: 4px;"><a
                        href="dashboardAnalista.html">Dash Analista</a>
                </li>
                <li style="display: flex; align-items: center;" data-role="Técnico,Administrador"><img
                        src="./assets/dashboard-icons/bar-chart.svg" style="width: 20px; margin-right: 4px;"><a
                        href="dashboardSuporteMacro.html">Dash Suporte Macro</a></li>
                <li style="display: flex; align-items: center;" data-role="Técnico,Administrador"><img
                        src="./assets/dashboard-icons/layout.svg" style="width: 20px; margin-right: 4px;"><a
                        href="dashboardSuporteMicro.html">Dash Suporte Micro</a></li>
                <li style="display: flex; align-items: center;" data-role="Técnico,Administrador">
                    <img src="./assets/dashboard-icons/wifi (1).svg" style="width: 20px; margin-right: 4px;"><a
                        href="dashRede.html">Dashboard Rede</a>
                </li>
            </div>

            <div class="menu_baixo">
                <h3 class="title_menu">Outras Opções</h3>
                <li style="display: flex; align-items: center;" data-role="Administrador" class="pagina-ativa"><img
                        src="./assets/dashboard-icons/gerenciar-usuarios.png" style="width: 20px; margin-right: 4px;"><a
                        href="dashControleSistema.html">Gerenciar usuários</a></li>
                <li style="display: flex; align-items: center;" data-role="Analista,Técnico,Administrador"><img
                        src="./assets/dashboard-icons/calendar.svg" style="width: 20px; margin-right: 4px;"><a
                        href="historicoAlertas.html">Histórico de Alertas</a></li>
                <li style="display: flex; align-items: center;" data-role="Administrador"><img
                        src="./assets/dashboard-icons/users.svg" style="width: 20px; margin-right: 4px;"><a
                        href="cadastroFuncionarios.html">Cadastro Funcionário</a></li>
                <li style="display: flex; align-items: center;" data-role="Técnico,Administrador"><img
                        src="./assets/dashboard-icons/hard-drive.svg" style="width: 20px; margin-right: 4px;"><a
                        href="cadastroServidores.html">Cadastro Servidores</a></li>
                <li style="display: flex; align-items: center;" data-role="Analista,Técnico,Administrador"><img
                        src="./assets/dashboard-icons/help-circle.svg" style="width: 20px; margin-right: 4px;"><a
                        href="https://vitalviewsptech.atlassian.net/servicedesk/customer/portal/1"
                        target="_blank">Central de Serviço</a></li>
                <li style="display: flex; align-items: center;" data-role="Analista,Técnico,Administrador"><img
                        src="./assets/dashboard-icons/log-out.svg" style="width: 20px; margin-right: 4px;"><a
                        onclick="limparSessao()">Sair</a></li>
            </div>
        </ul>
    </nav>

    <section class="container">
        <section class="nav-dash">
            <section class="secao_logo">
                <a href="dashboardAnalista.html">
                    <img src="assets/LogoVitalView.png" alt="Logo VitalView" class="logo">
                </a>
            </section>
            <section class="secao_logo">
                <h1 class="titulo_header">VitalView</h1>
            </section>
        </section>

        <div class="container-principal">
            <!-- MODAL CRESCIMENTO MÉDIO DE IMAGEM-->
            <div id="infoModalProdutividade" class="modal">
                <div class="modal-content">
                    <h3>Crescimento médio de imagens</h3>
                    <br>
                    <p style="text-align: justify; font-size: 20px;">
                        Define o nível de estabilidade com base na média do crescimento de imagens de cada mês<br><br>
                        &gt;= 50 imagens: <span style="color: #f75454;"><b>Atenção</b></span><br>
                        &lt; 50 imagens <span style="color: #32b9cd;"><b>Estável</b></span>
                    </p>
                    <button type="button" class="closeBtn">Fechar</button>
                </div>
            </div>

            <!-- MODAL CRESCIMENTO MÉDIO DE IMAGEM-->
            <div id="infoCrescimentoImagem" class="modal">
                <div class="modal-content">
                    <h3>Tamanho médio das imagens</h3>
                    <br>
                    <p style="text-align: justify; font-size: 20px;">
                        Define o nível de estabilidade de tamanho dos arquivos calculando a média de tamanho
                        das imagens:<br><br>
                        &gt;= 0.5MB: <span style="color: #f75454;"><b>Atenção</b></span><br>
                        &lt; 0.4MB: <span style="color: #32b9cd;"><b>Estável</b></span>
                    </p>
                    <button type="button" class="closeBtn">Fechar</button>
                </div>
            </div>

            <div class="container-graficos">
                <div class="kpi">
                    <h2 class="normal">Imagem mais pesada:</h2>
                    <div class="sub">Em megabytes</div>
                    <div class="value" id="div_imagem_mais_pesada"></div>
                </div>

                <div class="kpi">
                    <div class="kpi-badge"><span style="color: #32b9cd;" id="span_crescimento"></span></div>
                    <h2 class="normal">Crescimento médio de imagens <button type="button" class="infoBtn"
                            data-target="infoModalProdutividade">&#9432</button></h3>
                    </h2>
                    <div class="sub">Imagens por mês</div>
                    <div class="value" id="div_crescimento_medio_imagem_mes"></div>
                </div>

                <div class="kpi">
                    <div class="kpi-badge"><span style="color: #ef4444;"
                            id="span_estabilidade_tamanho_medio_imagem"></span></div>
                    <h2 class="normal">Tamanho médio das imagens <button type="button" class="infoBtn"
                            data-target="infoCrescimentoImagem">&#9432</button></h2>
                    <div class="sub">Tamanho médio por imagem</div>
                    <div class="value"><span style="color: #ef4444;" id="span_tamanho_medio_imagem"></span></div>
                </div>
            </div>

            <div class="tabela-alertas">
                <div class="tabela-header">
                    <div>
                        <h2>Imagens que podem ser removidas: <b id="b_imagens_removiveis"></b></h2>
                    </div>
                </div>

                <div class="tabela-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th id="th-sup-esquerdo">Nome do arquivo</th>
                                <th>Tamanho</th>
                                <th>Data de geração</th>
                                <th>Tempo no sistema</th>
                                <th id="th-sup-direito">Excluir</th>
                            </tr>
                        </thead>
                        <tbody id="info-imagens">

                        </tbody>
                    </table>
                </div>

                <div class="div_grafico">
                    <canvas id="grafico-linha"></canvas>
                </div>
            </div>
        </div>
    </section>

    <script>
        const params = new URLSearchParams(window.location.search);

        const idServidor = params.get("idServidor");
        const nomeServidor = params.get("hostname");

        let key = `suporte/imagens/${idServidor}_${nomeServidor}_hsl_imagens.json`;
        let key2 = "1_srv1_hsl.json";

        function carregarInformacoes() {
            fetch(`/ger-imagem/buscar-dados-bucket/${encodeURIComponent(key)}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                }
            })
                .then(response => {
                    if (response.ok) {
                        response.json().then(resposta => {
                            console.log("Dado recebido: ", resposta);
                            gerarKpiImagemMaisPesada(resposta);
                            gerarTabelaImagens(resposta);
                            gerarKpiCrescimentoMedioImagens(resposta);
                            gerarKpiTamanhoMedioImagens(resposta);
                            gerarGraficoLinha(resposta);
                        })
                    }
                })
                .catch((erro) => {
                    console.error("Erro na requisição: ", erro);
                    alert("Erro na conexão com o servidor.");
                });
        }

        function gerarTabelaImagens(dados) {
            let tbodyImagens = document.getElementById("info-imagens");
            tbodyImagens.innerHTML = "";

            b_imagens_removiveis.innerHTML = dados.imagens_removiveis.length;

            for (let i = 0; i < dados.imagens_removiveis.length; i++) {
                let img = dados.imagens_removiveis[i];

                let dataGeracao = new Date(img.data_geracao);
                let hoje = new Date();
                let diffMs = hoje - dataGeracao;
                let tempoNoSistema = Math.floor(diffMs / (1000 * 60 * 60 * 24 * 365));

                let dataFormatada = new Date(img.data_geracao)
                    .toLocaleDateString("pt-BR", { timeZone: "UTC" });

                let linha = `
            <tr>
                <td hidden>${img.caminho_arquivo}</td>
                <td>${img.nome_arquivo}</td>
                <td>${img.tamanho} MB</td>
                <td>${dataFormatada}</td>
                <td>${tempoNoSistema} anos</td>
                <td class="acao-icons">
                    <button class="btn-excluir-usuario" onclick="excluirImagem(this)">&#x1F5D1;</button>
                </td>
            </tr>
        `;

                tbodyImagens.innerHTML += linha;
            }
        }


        function excluirImagem(botao) {

            let linha = botao.closest("tr");
            let colunas = linha.querySelectorAll("td");

            let caminhoArquivo = colunas[0].textContent;
            let tempoNoSistema = colunas[3].textContent;

            fetch(`jira/abrir-chamado-exclusao`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    caminhoArquivoServer: caminhoArquivo,
                    tempoNoSistemaServer: tempoNoSistema
                })
            }).then(function (resposta) {
                if (resposta.ok) {
                    console.log(resposta);
                    alert(`Chamado para exclusão aberta com sucesso!`)
                }

            }).catch(function (erro) {
                console.log(erro);
            })
        }

        function gerarKpiImagemMaisPesada(dado) {
            let nomeImagem = dado.imagem_mais_pesada.nome_arquivo;
            let tamanho = dado.imagem_mais_pesada.tamanho;

            div_imagem_mais_pesada.innerHTML = `<span style="color: #ef4444"   >${nomeImagem} - ${tamanho}MB</span>`
        }

        function gerarKpiCrescimentoMedioImagens(dado) {
            let media = Number(dado.crescimento_medio_mes.media_imagens_por_mes).toFixed(0);

            div_crescimento_medio_imagem_mes.innerHTML = `${media} imagens`;
            div_crescimento_medio_imagem_mes.style.color = "#32b9cd";

            span_crescimento.innerHTML = "Estável";
            span_crescimento.style.color = "#32b9cd";

            if (media > 0.27) {
                div_crescimento_medio_imagem_mes.style.color = "#ef4444";

                span_crescimento.innerHTML = "Atenção";
                span_crescimento.style.color = "#ef4444";
            }
        }

        function gerarKpiTamanhoMedioImagens(dado) {
            let tamanhoMedio = Number(dado.tamanho_medio_imagens.tamanho_medio).toFixed(2);

            span_tamanho_medio_imagem.innerHTML = `${tamanhoMedio}MB`;
            span_tamanho_medio_imagem.style.color = "#32b9cd";

            span_estabilidade_tamanho_medio_imagem.innerHTML = "Estável";
            span_estabilidade_tamanho_medio_imagem.style.color = "#32b9cd";

            if (tamanhoMedio > 2) {
                span_tamanho_medio_imagem.style.color = "#ef4444";

                span_estabilidade_tamanho_medio_imagem.innerHTML = "Atenção";
                span_estabilidade_tamanho_medio_imagem.style.color = "#ef4444";
            }
        }
        function gerarGraficoLinha(dado) {
            let labels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez']

            let eixoY = [
                dado.crescimento_mensal.jan,
                dado.crescimento_mensal.fev,
                dado.crescimento_mensal.mar,
                dado.crescimento_mensal.abr,
                dado.crescimento_mensal.mai,
                dado.crescimento_mensal.jun,
                dado.crescimento_mensal.jul,
                dado.crescimento_mensal.ago,
                dado.crescimento_mensal.set,
                dado.crescimento_mensal.out,
                dado.crescimento_mensal.nov,
                dado.crescimento_mensal.dez,
            ];

            let limite = Number((dado.crescimento_mensal.dez * 1.2).toFixed(0));


            const ctx = document.getElementById('grafico-linha').getContext('2d');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${nomeServidor}`,
                        data: eixoY,
                        borderColor: '#1ECBE1',
                        backgroundColor: 'rgba(255, 0, 0, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Crescimento de Imagens - ${nomeServidor}`,
                            color: 'white',
                            font: {
                                size: 20,
                                family: 'Barlow, sans-serif',
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: 'white',
                                font: {
                                    family: 'Barlow, sans-serif'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: limite,
                            ticks: {
                                color: 'white',
                                font: {
                                    family: 'Barlow, sans-serif'
                                }
                            },
                            title: {
                                display: false
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.2)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'white',
                                font: {
                                    family: 'Barlow, sans-serif'
                                }
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.2)'
                            }
                        }
                    }
                }

            });
        }

        let infoBtns = document.querySelectorAll('.infoBtn');
        let modals = document.querySelectorAll('.modal');
        let closeBtns = document.querySelectorAll('.closeBtn');

        infoBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                let target = btn.dataset.target;
                document.getElementById(target).style.display = 'flex';
            });
        });

        closeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('.modal').style.display = 'none';
            });
        });

        modals.forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.style.display = 'none';
            });
        });
    </script>
</body>

</html>