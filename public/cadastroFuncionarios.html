<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>VitalView</title>

  <script src="js/sessao.js"></script>
  <link rel="stylesheet" href="./css/cadastroFuncionarios.css" />
  <link rel="icon" href="./assets/LogoVitalView.png" />
  <link rel="preconnect" href="https://fonts.gstatic.com" />
</head>

<body>
  <header class="escuro">
    <section class="container">

      <nav class="menu">
        <input type="checkbox" name="chk_hamburguer" id="chk_hamburguer" class="check_hamburguer">

        <section class="hamburguer">
          <span class="menu_lateral">
            <div class="icones_topo">
              <img class="img_hamb" src="assets/LogoVitalView.png">
              <img src="./assets/dashboard-icons/activity.svg" data-role="Analista,Administrador">
              <img src="./assets/dashboard-icons/bar-chart.svg" data-role="Técnico,Administrador">
              <img src="./assets/dashboard-icons/layout.svg" data-role="Técnico,Administrador">
            </div>

            <div class="icones_baixo">
              <img src="./assets/dashboard-icons/gerenciar-usuarios.png" data-role="Administrador" style="width: 28px; height: 28px;">
              <img src="./assets/dashboard-icons/calendar.svg" data-role="Analista,Técnico,Administrador">
              <img src="./assets/dashboard-icons/users.svg" data-role="Administrador">
              <img src="./assets/dashboard-icons/hard-drive.svg" data-role="Técnico,Administrador">
              <img src="./assets/dashboard-icons/help-circle.svg" data-role="Analista,Técnico,Administrador">
              <img src="./assets/dashboard-icons/log-out.svg" data-role="Analista,Técnico,Administrador">
            </div>
          </span>
        </section>

        <ul>
          <div class="title_hamb">
            <img class="img_hamb" src="assets/LogoVitalView.png" alt="">
            <h2 class="hamb_nome">VitalView</h2>
          </div>
          <div class="menu_topo">
            <h3 class="title_menu">Dashboards</h3>
            <li style="display: flex; align-items: center;" data-role="Analista,Administrador,Técnico">
              <img src="./assets/dashboard-icons/home.svg" style="width: 20px; margin-right: 4px;"><a
                href="bemVindo.html">Home</a>
            </li>
            <li style="display: flex; align-items: center;" data-role="Analista,Administrador"><img
                src="./assets/dashboard-icons/activity.svg" style="width: 20px; margin-right: 4px;"><a
                href="dashboardAnalista.html">Dash Analista</a></li>
            <li style="display: flex; align-items: center;" data-role="Técnico,Administrador"><img
                src="./assets/dashboard-icons/bar-chart.svg" style="width: 20px; margin-right: 4px;"><a
                href="dashboardSuporteMacro.html">Dash Suporte Macro</a></li>
            <li style="display: flex; align-items: center;" data-role="Técnico,Administrador"><img
                src="./assets/dashboard-icons/layout.svg" style="width: 20px; margin-right: 4px;"><a
                href="dashboardSuporteMicro.html">Dash Suporte Micro</a></li>
                <li style="display: flex; align-items: center;" data-role="Técnico,Administrador">
                    <img src="./assets/dashboard-icons/wifi (1).svg" style="width: 20px; margin-right: 4px;"><a
                        href="dashRede.html">Dashboard Rede</a>
                </li>
          </div>

          <div class="menu_baixo">
            <h3 class="title_menu">Outras Opções</h3>
            <li style="display: flex; align-items: center;" data-role="Administrador"><img
                src="./assets/dashboard-icons/gerenciar-usuarios.png" style="width: 20px; margin-right: 4px;"><a
                href="dashControleSistema.html">Gerenciar usuários</a></li>
            <li style="display: flex; align-items: center;" data-role="Analista,Técnico,Administrador"><img
                src="./assets/dashboard-icons/calendar.svg" style="width: 20px; margin-right: 4px;"><a
                href="historicoAlertas.html">Histórico de Alertas</a></li>
            <li style="display: flex; align-items: center;" data-role="Administrador" class="pagina-ativa"><img
                src="./assets/dashboard-icons/users.svg" style="width: 20px; margin-right: 4px;"><a
                href="cadastroFuncionarios.html">Cadastro Funcionário</a></li>
            <li style="display: flex; align-items: center;" data-role="Técnico,Administrador"><img
                src="./assets/dashboard-icons/hard-drive.svg" style="width: 20px; margin-right: 4px;"><a
                href="cadastroServidores.html">Cadastro Servidores</a></li>
            <li style="display: flex; align-items: center;" data-role="Analista,Técnico,Administrador"><img
                src="./assets/dashboard-icons/help-circle.svg" style="width: 20px; margin-right: 4px;"><a
                href="https://vitalviewsptech.atlassian.net/servicedesk/customer/portal/1" target="_blank">Central de
                Serviço</a></li>
            <li style="display: flex; align-items: center;" data-role="Analista,Técnico,Administrador"><img
                src="./assets/dashboard-icons/log-out.svg" style="width: 20px; margin-right: 4px;"><a
                onclick="limparSessao()">Sair</a></li>
          </div>
        </ul>
      </nav>

      <section class="secao_logo">
        <h1 class="titulo_header">Cadastro de Funcionários</h1>
      </section>

      <section class="secao_logo">
        <a href="dashboard.html">
          <img src="assets/LogoVitalView.png" alt="Logo VitalView" class="logo">
        </a>
        <div class="linha"></div>
      </section>
    </section>
  </header>


  <div class="container-funcionario">
    <div class="card">
      <div class="formulario">
        <div class="campo">
          <span>Nome:</span>
          <input id="nome_input" type="text" placeholder="Seu nome" />
        </div>
        <div class="campo">
          <span>CPF:</span>
          <input id="cpf_input" type="text" placeholder="Seu cpf" />
        </div>
        <div class="campo">
          <span>Telefone:</span>
          <input id="telefone_input" type="text" placeholder="Seu telefone" />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="formulario">
        <div class="campo">
          <span>E-mail:</span>
          <input id="email_input" type="text" placeholder="meuemail@provedor.com" />
        </div>
        <div class="campo">
          <span>Senha:</span>
          <input id="senha_input" type="password" placeholder="******" />
        </div>
        <div class="campo">
          <span>Confirmação da Senha:</span>
          <input id="confirmacao_senha_input" type="password" placeholder="******" />
        </div>

        <div class="campo">
          <span>Cargo:</span>
          <select name="" id="cargo_input" onchange="mostrar()">
            <option value="">Escolha uma opção</option>
          </select>
        </div>

        <div class="form-actions">
          <button type="reset" class="btn cancel" onclick="limparFormulario()">Limpar</button>
          <button type="submit" class="btn save" onclick="cadastrar()">Cadastrar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="div_resposta"></div>

  <script src="js/permissoes.js"></script>

  <script>

    protegerPagina(['Administrador']);
    aplicarCargoNaUI();


    document.addEventListener("DOMContentLoaded", () => {
      const cargoSelect = document.getElementById("cargo_input");


      const cargos = [
        { nome: "Analista", id: 1 },
        { nome: "Técnico", id: 2 },
        { nome: "Administrador", id: 3 }
      ];

      cargos.forEach(cargo => {
        const opt = document.createElement("option");
        opt.value = cargo.id;
        opt.textContent = cargo.nome;
        cargoSelect.appendChild(opt);
      });
    });


    function limparFormulario() {
      nome_input.value = "";
      cpf_input.value = "";
      telefone_input.value = "";
      email_input.value = "";
      senha_input.value = "";
      confirmacao_senha_input.value = "";
      cargo_input.value = "";
      div_resposta.innerHTML = "";
    }

    function mostrar() {

    }


    function cadastrar() {

      const nome = nome_input.value.trim();
      const cpf = cpf_input.value.trim();
      const telefone = telefone_input.value.trim();
      const email = email_input.value.trim();
      const senha = senha_input.value;
      const confirmacaoSenha = confirmacao_senha_input.value;
      const agora = new Date();
      const dataCriacao = agora.toISOString().split("T")[0];
      
      const fkCargo = cargo_input.value;
      const fkHospital = sessionStorage.FK_HOSPITAL;

      if (!fkHospital) {
        div_resposta.innerHTML = `
      <span style="color: red; font-weight: 600;">
        Erro: fkHospital não encontrada na sessão. Faça login novamente como Administrador.
      </span>`;
        return;
      }

      if (!nome || !cpf || !telefone || !email || !senha || !confirmacaoSenha || !fkCargo) {
        div_resposta.innerHTML = `
      <span style="color: red; font-weight: 600;">
        Preencha todos os campos.
      </span>`;
        return;
      }

      if (senha !== confirmacaoSenha) {
        div_resposta.innerHTML = `
      <span style="color: red; font-weight: 600;">
        Senha e confirmação não conferem.
      </span>`;
        return;
      }


      const novoFuncionario = {
        nome: nome,
        cpf: cpf,
        telefone: telefone,
        email: email,
        senha: senha,
        data_criacao: dataCriacao,
        fkCargo: Number(fkCargo),
        fkHospital: Number(fkHospital)
      };


      fetch("/usuarios/cadastrar", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(novoFuncionario)
      })
        .then(resposta => {
          if (resposta.ok) {
            return resposta.json();
          } else {
            return resposta.text().then(texto => {
              throw new Error(texto);
            });
          }
        })
        .then(json => {

          alert("Funcionário cadastrado com sucesso!")

          limparFormulario();
        })
        .catch(erro => {

          console.error("Erro no cadastro:", erro);
          div_resposta.innerHTML = `
        <span style="color: red; font-weight: 600; text-align: center;">
          Erro ao cadastrar funcionário:<br>${erro.message}
        </span>`;
        });
    }

  </script>

</body>

</html>